import 'dart:convert';

import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

import '../../services/pro_access.dart';

class AdminScreen extends StatefulWidget {
  const AdminScreen({super.key});

  @override
  State<AdminScreen> createState() => _AdminScreenState();
}

class _AdminScreenState extends State<AdminScreen> {
  // ----------------- KEYS (mantém compatível com o que você já usa) -----------------
  static const _kAdminAuthed = 'admin_authed_v1';
  static const _kAdminPass = 'admin_pass_v1';

  static const _kCupomEnabled = 'cupom_enabled_v1';
  static const _kCupomCode = 'cupom_code_v1';
  static const _kCupomPct = 'cupom_pct_v1';
  static const _kCupomEndAtMs = 'cupom_endat_ms_v1'; // NOVO: expiração do cupom

  static const _kHomeNotice = 'home_notice_v1'; // HomeScreen já usa isso

  static const _kLinksWhats = 'links_whats_v1';
  static const _kLinksInsta = 'links_insta_v1';
  static const _kLinksFace = 'links_face_v1';

  static const _kPartnersJson = 'partners_json_v1';
  static const _kServicePricesJson = 'service_prices_json_v1';

  // ----------------- SENHA -----------------
  bool _loadingAuth = true;
  bool _authed = false;

  final _passCtrl = TextEditingController();
  final _newPassCtrl = TextEditingController();

  // ----------------- CUPOM -----------------
  bool _cupomEnabled = false;
  final _cupomCodeCtrl = TextEditingController(text: 'FG10');
  final _cupomPctCtrl = TextEditingController(text: '10');
  final _cupomDaysCtrl = TextEditingController(text: '7');
  int? _cupomEndAtMs; // ms epoch

  // ----------------- AVISO HOME -----------------
  final _noticeCtrl = TextEditingController();

  // ----------------- LINKS -----------------
  final _whatsCtrl = TextEditingController();
  final _instaCtrl = TextEditingController();
  final _faceCtrl = TextEditingController();

  // ----------------- PARCEIROS -----------------
  final _partnerNameCtrl = TextEditingController();
  final _partnerUrlCtrl = TextEditingController();
  final _partnerDiscountCtrl = TextEditingController(text: '10');
  List<Map<String, dynamic>> _partners = [];

  // ----------------- PREÇOS DE SERVIÇOS (Admin) -----------------
  final _svcNameCtrl = TextEditingController();
  final _svcPriceCtrl = TextEditingController();
  final _svcNotesCtrl = TextEditingController();
  List<Map<String, dynamic>> _servicePrices = [];

  // UI
  static const _bg = Color(0xFF0E1116);
  static const _card = Color(0xFF141A22);
  static const _border = Color(0xFF2B2F3A);
  static const _gold = Color(0xFFFFC857);

  @override
  void initState() {
    super.initState();
    _loadAll();
  }

  @override
  void dispose() {
    _passCtrl.dispose();
    _newPassCtrl.dispose();

    _cupomCodeCtrl.dispose();
    _cupomPctCtrl.dispose();
    _cupomDaysCtrl.dispose();

    _noticeCtrl.dispose();

    _whatsCtrl.dispose();
    _instaCtrl.dispose();
    _faceCtrl.dispose();

    _partnerNameCtrl.dispose();
    _partnerUrlCtrl.dispose();
    _partnerDiscountCtrl.dispose();

    _svcNameCtrl.dispose();
    _svcPriceCtrl.dispose();
    _svcNotesCtrl.dispose();

    super.dispose();
  }

  Future<void> _loadAll() async {
    final sp = await SharedPreferences.getInstance();

    // senha
    final pass = (sp.getString(_kAdminPass) ?? '').trim();
    if (pass.isEmpty) {
      // se nunca setou, cria padrão
      await sp.setString(_kAdminPass, '2468');
    }
    final ok = sp.getBool(_kAdminAuthed) ?? false;

    // cupom
    _cupomEnabled = sp.getBool(_kCupomEnabled) ?? false;
    _cupomCodeCtrl.text = (sp.getString(_kCupomCode) ?? 'FG10').trim();
    _cupomPctCtrl.text = (sp.getString(_kCupomPct) ?? '10').trim();
    _cupomEndAtMs = sp.getInt(_kCupomEndAtMs);

    // aviso
    _noticeCtrl.text = (sp.getString(_kHomeNotice) ?? '').trim();

    // links
    _whatsCtrl.text = (sp.getString(_kLinksWhats) ?? '').trim();
    _instaCtrl.text = (sp.getString(_kLinksInsta) ?? '').trim();
    _faceCtrl.text = (sp.getString(_kLinksFace) ?? '').trim();

    // parceiros
    _partners = _decodeListMap(sp.getString(_kPartnersJson)) ?? [];

    // serviços
    _servicePrices = _decodeListMap(sp.getString(_kServicePricesJson)) ?? _seedServicePrices();

    if (!mounted) return;
    setState(() {
      _authed = ok;
      _loadingAuth = false;
    });
  }

  List<Map<String, dynamic>>? _decodeListMap(String? raw) {
    if (raw == null || raw.trim().isEmpty) return null;
    try {
      final j = jsonDecode(raw);
      if (j is List) {
        return j.map((e) => (e as Map).map((k, v) => MapEntry(k.toString(), v))).toList();
      }
    } catch (_) {}
    return null;
  }

  void _snack(String msg) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(msg)));
  }

  InputDecoration _dec(String label) => InputDecoration(
        labelText: label,
        filled: true,
        fillColor: _card,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(14)),
      );

  Widget _box({required Widget child}) {
    return Container(
      margin: const EdgeInsets.only(bottom: 14),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: _card,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: _border),
      ),
      child: child,
    );
  }

  // ----------------- AUTH -----------------
  Future<void> _login() async {
    final sp = await SharedPreferences.getInstance();
    final saved = (sp.getString(_kAdminPass) ?? '2468').trim();
    final typed = _passCtrl.text.trim();

    if (typed == saved) {
      await sp.setBool(_kAdminAuthed, true);
      if (!mounted) return;
      setState(() => _authed = true);
      _snack('Admin liberado ✅');
      return;
    }

    _snack('Senha incorreta ❌');
  }

  Future<void> _logout() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setBool(_kAdminAuthed, false);
    if (!mounted) return;
    setState(() => _authed = false);
    _snack('Admin bloqueado ✅');
  }

  Future<void> _setPassword() async {
    final v = _newPassCtrl.text.trim();
    if (v.length < 4) {
      _snack('Senha muito curta (mín 4).');
      return;
    }
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kAdminPass, v);
    _newPassCtrl.clear();
    _snack('Senha alterada ✅');
  }

  Future<void> _resetPassword1234() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kAdminPass, '1234');
    _snack('Senha resetada para 1234 ✅');
  }

  // ----------------- CUPOM -----------------
  int? _calcEndAtFromDays() {
    final days = int.tryParse(_cupomDaysCtrl.text.trim());
    if (days == null || days <= 0) return null;
    final ms = DateTime.now().add(Duration(days: days)).millisecondsSinceEpoch;
    return ms;
  }

  String _fmtLeft(int msLeft) {
    if (msLeft <= 0) return 'expirado';
    final s = (msLeft / 1000).floor();
    final d = s ~/ 86400;
    final h = (s % 86400) ~/ 3600;
    final m = (s % 3600) ~/ 60;
    return '${d}d ${h}h ${m}m';
  }

  Future<void> _saveCupom() async {
    final sp = await SharedPreferences.getInstance();
    final code = _cupomCodeCtrl.text.trim();
    final pct = _cupomPctCtrl.text.trim();

    // endAt: se já existe, mantém; se não existe e usuário informou dias, cria
    _cupomEndAtMs ??= _calcEndAtFromDays();

    await sp.setBool(_kCupomEnabled, _cupomEnabled);
    await sp.setString(_kCupomCode, code);
    await sp.setString(_kCupomPct, pct);
    if (_cupomEndAtMs != null) {
      await sp.setInt(_kCupomEndAtMs, _cupomEndAtMs!);
    } else {
      await sp.remove(_kCupomEndAtMs);
    }

    _snack('Cupom salvo ✅');
    setState(() {});
  }

  Future<void> _clearCupom() async {
    final sp = await SharedPreferences.getInstance();
    _cupomEnabled = false;
    _cupomEndAtMs = null;
    await sp.setBool(_kCupomEnabled, false);
    await sp.remove(_kCupomEndAtMs);
    _snack('Cupom desativado ✅');
    if (!mounted) return;
    setState(() {});
  }

  Future<void> _extendCupomDays(int days) async {
    final now = DateTime.now().millisecondsSinceEpoch;
    final cur = _cupomEndAtMs;

    // se já existe e ainda não expirou, soma em cima dele
    if (cur != null && cur > now) {
      _cupomEndAtMs = cur + Duration(days: days).inMilliseconds;
    } else {
      // senão cria a partir de agora
      _cupomEndAtMs = now + Duration(days: days).inMilliseconds;
    }

    await _saveCupom();
    if (!mounted) return;
    setState(() {});
  }

  // ----------------- HOME NOTICE -----------------
  Future<void> _saveNotice() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kHomeNotice, _noticeCtrl.text.trim());
    _snack('Aviso salvo ✅');
  }

  // ----------------- LINKS -----------------
  Future<void> _saveLinks() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kLinksWhats, _whatsCtrl.text.trim());
    await sp.setString(_kLinksInsta, _instaCtrl.text.trim());
    await sp.setString(_kLinksFace, _faceCtrl.text.trim());
    _snack('Links salvos ✅');
  }

  // ----------------- PARCEIROS -----------------
  Future<void> _savePartners() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kPartnersJson, jsonEncode(_partners));
  }

  Future<void> _addPartner() async {
    final name = _partnerNameCtrl.text.trim();
    final url = _partnerUrlCtrl.text.trim();
    final disc = double.tryParse(_partnerDiscountCtrl.text.replaceAll(',', '.').trim()) ?? 0;

    if (name.isEmpty) {
      _snack('Nome do parceiro vazio.');
      return;
    }

    _partners.add({"name": name, "url": url, "discount": disc});
    _partnerNameCtrl.clear();
    _partnerUrlCtrl.clear();

    await _savePartners();
    _snack('Parceiro adicionado ✅');
    setState(() {});
  }

  Future<void> _removePartner(int i) async {
    _partners.removeAt(i);
    await _savePartners();
    setState(() {});
  }

  // ----------------- SERVIÇOS (PREÇOS) -----------------
  List<Map<String, dynamic>> _seedServicePrices() {
    // Valores base já “mais normais” (você pode ajustar depois no Admin)
    return [
      {"name": "Padrão ENEL 127V", "price": 780.0, "notes": "Base (varia por poste/caixa)"},
      {"name": "Padrão ENEL 220V", "price": 950.0, "notes": "Base (varia por poste/caixa)"},
      {"name": "Instalação de chuveiro", "price": 180.0, "notes": "Sem material"},
      {"name": "Troca de disjuntor", "price": 120.0, "notes": "Sem material"},
      {"name": "Tomada/Interruptor (un)", "price": 60.0, "notes": ""},
      {"name": "Ponto de luz (un)", "price": 90.0, "notes": ""},
      {"name": "Ventilador de teto", "price": 220.0, "notes": ""},
      {"name": "Visita técnica", "price": 80.0, "notes": ""},
    ];
  }

  Future<void> _saveServicePrices() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kServicePricesJson, jsonEncode(_servicePrices));
  }

  Future<void> _addServicePrice() async {
    final name = _svcNameCtrl.text.trim();
    final price = double.tryParse(_svcPriceCtrl.text.replaceAll(',', '.').trim()) ?? 0.0;
    final notes = _svcNotesCtrl.text.trim();

    if (name.isEmpty) {
      _snack('Nome do serviço vazio.');
      return;
    }

    _servicePrices.add({"name": name, "price": price, "notes": notes});
    _svcNameCtrl.clear();
    _svcPriceCtrl.clear();
    _svcNotesCtrl.clear();

    await _saveServicePrices();
    _snack('Serviço adicionado ✅');
    setState(() {});
  }

  Future<void> _removeServicePrice(int i) async {
    _servicePrices.removeAt(i);
    await _saveServicePrices();
    setState(() {});
  }

  Future<void> _applyMultiplier(double mul) async {
    for (final s in _servicePrices) {
      final v = (s["price"] is num) ? (s["price"] as num).toDouble() : 0.0;
      s["price"] = double.parse((v * mul).toStringAsFixed(2));
    }
    await _saveServicePrices();
    setState(() {});
    _snack('Preços atualizados (x${mul.toStringAsFixed(2)}) ✅');
  }

  // ----------------- BUILD -----------------
  @override
  Widget build(BuildContext context) {
    if (_loadingAuth) {
      return const Scaffold(
        backgroundColor: _bg,
        body: Center(child: CircularProgressIndicator()),
      );
    }

    return Scaffold(
      backgroundColor: _bg,
      appBar: AppBar(
        backgroundColor: _bg,
        title: const Text('Admin'),
        actions: [
          if (_authed)
            IconButton(
              tooltip: 'Bloquear agora',
              onPressed: _logout,
              icon: const Icon(Icons.lock_outline),
            ),
        ],
      ),
      body: _authed ? _buildAdmin() : _buildLogin(),
    );
  }

  Widget _buildLogin() {
    return ListView(
      padding: const EdgeInsets.all(16),
      children: [
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text(
                'Senha do Admin',
                style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18),
              ),
              const SizedBox(height: 10),
              TextField(
                controller: _passCtrl,
                obscureText: true,
                decoration: _dec('Digite a senha'),
              ),
              const SizedBox(height: 12),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _gold,
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: _login,
                  child: const Text('Entrar', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
              const SizedBox(height: 10),
              Text(
                "Dica: se você nunca mudou, a senha padrão é 2468.",
                style: TextStyle(color: Colors.white.withOpacity(.70)),
              ),
            ],
          ),
        ),
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Trocar senha (Admin)',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900)),
              const SizedBox(height: 10),
              TextField(
                controller: _newPassCtrl,
                obscureText: true,
                decoration: _dec('Nova senha (mín 4)'),
              ),
              const SizedBox(height: 10),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: _setPassword,
                      style: OutlinedButton.styleFrom(
                        foregroundColor: _gold,
                        side: BorderSide(color: _gold.withOpacity(.7)),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Salvar nova senha', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: OutlinedButton(
                      onPressed: _resetPassword1234,
                      style: OutlinedButton.styleFrom(
                        foregroundColor: Colors.redAccent,
                        side: const BorderSide(color: Colors.redAccent),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Reset 1234', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildAdmin() {
    final nowMs = DateTime.now().millisecondsSinceEpoch;
    final endAt = _cupomEndAtMs;
    final msLeft = (endAt == null) ? null : (endAt - nowMs);

    final cupomStatus = () {
      if (!_cupomEnabled || _cupomCodeCtrl.text.trim().isEmpty) return 'Cupom desativado';
      if (endAt == null) return 'Cupom ativo (sem expiração definida)';
      if ((msLeft ?? 0) <= 0) return 'Cupom expirado';
      return 'Expira em: ${_fmtLeft(msLeft!)}';
    }();

    return ListView(
      padding: const EdgeInsets.all(16),
      children: [
        // CUPOM
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Cupom / Promoção',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              SwitchListTile(
                contentPadding: EdgeInsets.zero,
                value: _cupomEnabled,
                onChanged: (v) => setState(() => _cupomEnabled = v),
                title: const Text('Ativar cupom', style: TextStyle(color: Colors.white)),
              ),
              TextField(controller: _cupomCodeCtrl, decoration: _dec('Código (ex: FG10)')),
              const SizedBox(height: 10),
              TextField(
                controller: _cupomPctCtrl,
                keyboardType: const TextInputType.numberWithOptions(decimal: true),
                decoration: _dec('Desconto (%) — ex: 10'),
              ),
              const SizedBox(height: 10),
              Row(
                children: [
                  Expanded(
                    child: TextField(
                      controller: _cupomDaysCtrl,
                      keyboardType: TextInputType.number,
                      decoration: _dec('Dias para expirar (ex: 7)'),
                    ),
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () {
                        final v = _calcEndAtFromDays();
                        setState(() => _cupomEndAtMs = v);
                        _snack(v == null ? 'Dias inválido.' : 'Expiração setada ✅ (agora salve)');
                      },
                      style: OutlinedButton.styleFrom(
                        foregroundColor: _gold,
                        side: BorderSide(color: _gold.withOpacity(.7)),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Setar expiração', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 10),
              Text(cupomStatus, style: TextStyle(color: Colors.white.withOpacity(.80), fontWeight: FontWeight.w700)),
              const SizedBox(height: 10),
              Row(
                children: [
                  Expanded(
                    child: ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: _gold,
                        foregroundColor: Colors.black,
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      onPressed: _saveCupom,
                      child: const Text('Salvar cupom', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: OutlinedButton(
                      onPressed: _clearCupom,
                      style: OutlinedButton.styleFrom(
                        foregroundColor: Colors.redAccent,
                        side: const BorderSide(color: Colors.redAccent),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Desativar', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 10),
              Wrap(
                spacing: 10,
                runSpacing: 10,
                children: [
                  OutlinedButton(
                    onPressed: () => _extendCupomDays(1),
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('+1 dia'),
                  ),
                  OutlinedButton(
                    onPressed: () => _extendCupomDays(3),
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('+3 dias'),
                  ),
                  OutlinedButton(
                    onPressed: () => _extendCupomDays(7),
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('+7 dias'),
                  ),
                  OutlinedButton(
                    onPressed: () => _extendCupomDays(30),
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('+30 dias'),
                  ),
                ],
              ),
            ],
          ),
        ),

        // AVISO HOME
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Aviso na Home',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              TextField(
                controller: _noticeCtrl,
                maxLines: 3,
                decoration: _dec('Texto do aviso (deixe vazio pra remover)'),
              ),
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _gold,
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: _saveNotice,
                  child: const Text('Salvar aviso', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
            ],
          ),
        ),

        // PREÇOS DE SERVIÇOS
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Tabela de preços (Serviços PRO)',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () async {
                        _servicePrices = _seedServicePrices();
                        await _saveServicePrices();
                        setState(() {});
                        _snack('Tabela base restaurada ✅');
                      },
                      style: OutlinedButton.styleFrom(
                        foregroundColor: _gold,
                        side: BorderSide(color: _gold.withOpacity(.7)),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Restaurar base', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => _applyMultiplier(0.65), // -35%
                      style: OutlinedButton.styleFrom(
                        foregroundColor: Colors.greenAccent,
                        side: const BorderSide(color: Colors.greenAccent),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Reduzir 35%', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 10),
              TextField(controller: _svcNameCtrl, decoration: _dec('Nome do serviço')),
              const SizedBox(height: 10),
              TextField(
                controller: _svcPriceCtrl,
                keyboardType: const TextInputType.numberWithOptions(decimal: true),
                decoration: _dec('Preço (R\$)'),
              ),
              const SizedBox(height: 10),
              TextField(controller: _svcNotesCtrl, decoration: _dec('Observações (opcional)')),
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _gold,
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: _addServicePrice,
                  child: const Text('Adicionar serviço', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
              const SizedBox(height: 12),
              ..._servicePrices.asMap().entries.map((e) {
                final i = e.key;
                final s = e.value;
                final name = (s["name"] ?? "").toString();
                final price = (s["price"] is num) ? (s["price"] as num).toDouble() : 0.0;
                final notes = (s["notes"] ?? "").toString();

                return Container(
                  margin: const EdgeInsets.only(bottom: 10),
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: const Color(0xFF10151D),
                    borderRadius: BorderRadius.circular(14),
                    border: Border.all(color: _border),
                  ),
                  child: Row(
                    children: [
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900)),
                            const SizedBox(height: 4),
                            Text('R\$ ${price.toStringAsFixed(2)}',
                                style: TextStyle(color: Colors.white.withOpacity(.75), fontWeight: FontWeight.w700)),
                            if (notes.trim().isNotEmpty)
                              Padding(
                                padding: const EdgeInsets.only(top: 4),
                                child: Text(notes, style: TextStyle(color: Colors.white.withOpacity(.60))),
                              ),
                          ],
                        ),
                      ),
                      IconButton(
                        onPressed: () => _removeServicePrice(i),
                        icon: const Icon(Icons.delete, color: Colors.redAccent),
                      ),
                    ],
                  ),
                );
              }),
            ],
          ),
        ),

        // PARCEIROS
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Parceiros',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              TextField(controller: _partnerNameCtrl, decoration: _dec('Nome')),
              const SizedBox(height: 10),
              TextField(controller: _partnerUrlCtrl, decoration: _dec('URL / contato')),
              const SizedBox(height: 10),
              TextField(
                controller: _partnerDiscountCtrl,
                keyboardType: const TextInputType.numberWithOptions(decimal: true),
                decoration: _dec('Desconto (%)'),
              ),
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _gold,
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: _addPartner,
                  child: const Text('Adicionar parceiro', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
              const SizedBox(height: 12),
              ..._partners.asMap().entries.map((e) {
                final i = e.key;
                final p = e.value;
                return Container(
                  margin: const EdgeInsets.only(bottom: 10),
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: const Color(0xFF10151D),
                    borderRadius: BorderRadius.circular(14),
                    border: Border.all(color: _border),
                  ),
                  child: Row(
                    children: [
                      Expanded(
                        child: Text(
                          '${p["name"] ?? ""}  •  ${p["discount"] ?? 0}%',
                          style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900),
                        ),
                      ),
                      IconButton(
                        onPressed: () => _removePartner(i),
                        icon: const Icon(Icons.delete, color: Colors.redAccent),
                      ),
                    ],
                  ),
                );
              }),
            ],
          ),
        ),

        // LINKS
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Links do app',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              TextField(controller: _whatsCtrl, decoration: _dec('WhatsApp (números)')),
              const SizedBox(height: 10),
              TextField(controller: _instaCtrl, decoration: _dec('Instagram (sem @)')),
              const SizedBox(height: 10),
              TextField(controller: _faceCtrl, decoration: _dec('Facebook URL')),
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _gold,
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: _saveLinks,
                  child: const Text('Salvar links', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
            ],
          ),
        ),

        // PRO/TRIAL (DEV)
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('PRO / Trial (DEV)',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              FutureBuilder<bool>(
                future: ProAccess.hasProAccessNow(),
                builder: (context, snap) {
                  final has = snap.data ?? false;
                  return Text(
                    has ? 'Acesso PRO agora: SIM ✅' : 'Acesso PRO agora: NÃO',
                    style: TextStyle(color: Colors.white.withOpacity(.85), fontWeight: FontWeight.w800),
                  );
                },
              ),
              const SizedBox(height: 10),
              Wrap(
                spacing: 10,
                runSpacing: 10,
                children: [
                  OutlinedButton(
                    onPressed: () async {
                      await ProAccess.setProDev(true);
                      _snack('PRO (DEV) ativado');
                      setState(() {});
                    },
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('Ativar PRO (DEV)'),
                  ),
                  OutlinedButton(
                    onPressed: () async {
                      await ProAccess.setProDev(false);
                      _snack('PRO (DEV) desativado');
                      setState(() {});
                    },
                    style: OutlinedButton.styleFrom(foregroundColor: Colors.redAccent, side: const BorderSide(color: Colors.redAccent)),
                    child: const Text('Desativar PRO (DEV)'),
                  ),
                  OutlinedButton(
                    onPressed: () async {
                      await ProAccess.startTrial(duration: const Duration(minutes: 10));
                      _snack('Trial 10 min ativado ✅');
                      setState(() {});
                    },
                    style: OutlinedButton.styleFrom(foregroundColor: Colors.greenAccent, side: const BorderSide(color: Colors.greenAccent)),
                    child: const Text('Trial 10 min'),
                  ),
                  OutlinedButton(
                    onPressed: () async {
                      await ProAccess.resetTrial();
                      _snack('Trial resetado ✅');
                      setState(() {});
                    },
                    style: OutlinedButton.styleFrom(foregroundColor: Colors.redAccent, side: const BorderSide(color: Colors.redAccent)),
                    child: const Text('Reset Trial'),
                  ),
                ],
              ),
            ],
          ),
        ),

        // BLOQUEAR
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Segurança',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: OutlinedButton(
                  style: OutlinedButton.styleFrom(
                    foregroundColor: Colors.redAccent,
                    side: const BorderSide(color: Colors.redAccent),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: () async {
                    await _logout();
                    if (!mounted) return;
                    Navigator.of(context).pop();
                  },
                  child: const Text('Bloquear Admin agora', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }
}
