import 'dart:convert';
import 'package:flutter/material.dart';
import '../../routes/app_routes.dart';
import 'package:shared_preferences/shared_preferences.dart';

import '../../services/pro_access.dart';

class AdminScreen extends StatefulWidget {
  const AdminScreen({super.key});

  @override
  State<AdminScreen> createState() => _AdminScreenState();
}

class _AdminScreenState extends State<AdminScreen> {
  String _adminPassSaved = '';

  final _cupomUntilCtrl = TextEditingController();

  bool _adminUnlocked = false;

  bool _adminLockLoaded = false;

  static const _kAdminUnlocked = 'admin_unlocked_v1';
  static const _kCupomUntil = 'cupom_until_v1';

  final bg = const Color(0xFF0E1117);
  final card = const Color(0xFF141A22);
  final border = const Color(0xFF2B2F3A);
  final gold = const Color(0xFFF7C948);

  // AUTH
  static const _kAdminPass = 'admin_pass_v1';
  static const _kAdminAuthed = 'admin_authed_v1';
  final _passCtrl = TextEditingController();
  bool _authed = false;
  bool _loadingAuth = true;

  // CUPOM
  static const _kCupomEnabled = 'cupom_enabled_v1';
  static const _kCupomCode = 'cupom_code_v1';
  static const _kCupomPct = 'cupom_pct_v1';
  static const _kCupomEndAt = 'cupom_end_at_v1';
  final _cupomDaysCtrl = TextEditingController(text: '7'); // duração em dias

  bool _cupomEnabled = false;
  final _cupomCodeCtrl = TextEditingController();
  final _cupomPctCtrl = TextEditingController(text: '10');

  // LINKS
  static const _kWhats = 'brand_whats_v1';
  static const _kInsta = 'brand_insta_v1';
  static const _kFace = 'brand_face_v1';
  final _whatsCtrl = TextEditingController(text: '5521997901083');
  final _instaCtrl = TextEditingController(text: 'fg_eletrica_ofc');
  final _faceCtrl = TextEditingController(text: 'https://www.facebook.com/share/1CSZ3681VC/');

  // FLAGS
  static const _kForceWatermark = 'flag_force_watermark_v1';
  static const _kRequireSign = 'flag_require_sign_v1';
  bool _forceWatermark = false;
  bool _requireSign = false;

  // AVISO HOME
  static const _kHomeNotice = 'home_notice_v1';
  final _noticeCtrl = TextEditingController();
  bool _noticeEnabled = false;

  // PARCEIROS
  static const _kPartnersJson = 'partners_v1';
  final _partnerNameCtrl = TextEditingController();
  final _partnerUrlCtrl = TextEditingController();
  final _partnerDiscountCtrl = TextEditingController();
  List<Map<String, dynamic>> _partners = [];

  // TABELA PREÇOS (SERVIÇOS)
  static const _kServicePricesJson = 'service_prices_v1';
  final _svcNameCtrl = TextEditingController();
  final _svcPriceCtrl = TextEditingController();
  final _svcNotesCtrl = TextEditingController();
  List<Map<String, dynamic>> _servicePrices = [];

  
  Future<void> _checkAdminGate() async {
    final sp = await SharedPreferences.getInstance();
    // se quiser, comente a linha abaixo pra sempre pedir senha
    _adminUnlocked = sp.getBool(_kAdminUnlocked) ?? false;
    if (_adminUnlocked) return;

    if (!mounted) return;
    await Future.delayed(const Duration(milliseconds: 150));

    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (_) {
        return AlertDialog(
          title: const Text('Admin — Senha'),
          content: TextField(
            controller: _passCtrl,
            obscureText: true,
            decoration: const InputDecoration(
              labelText: 'Digite a senha',
            ),
          ),
          actions: [
            TextButton(
              onPressed: () {
                Navigator.pop(context);
                // sai do admin se cancelar
                Navigator.of(context).pop();
              },
              child: const Text('Cancelar'),
            ),
            FilledButton(
              onPressed: () async {
                final sp = await SharedPreferences.getInstance();
                final saved = (sp.getString(_kAdminPass) ?? 'FG2026').trim();
                final typed = _passCtrl.text.trim();
                if (typed == saved) {
                  await sp.setBool(_kAdminUnlocked, true);
                  if (!mounted) return;
                  setState(() => _adminUnlocked = true);
                  Navigator.pop(context);
                }
              },
              child: const Text('Entrar'),
            ),
          ],
        );
      },
    );
  }
  Future<void> _loadAdminLock() async {
    final sp = await SharedPreferences.getInstance();
    final pass = (sp.getString(_kAdminPass) ?? '').trim();
    final unlocked = sp.getBool(_kAdminUnlocked) ?? false;
    final until = (sp.getString(_kCupomUntil) ?? '').trim();
    if (!mounted) return;
    setState(() {
      _adminPassSaved = pass;
      _adminUnlocked = unlocked && pass.isNotEmpty;
      _adminLockLoaded = true;
      _cupomUntilCtrl.text = until;
    });
  }

  Future<void> _lockAdminNow() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setBool(_kAdminUnlocked, false);
    if (!mounted) return;
    setState(() => _adminUnlocked = false);
  }



@override
  void initState() {

    super.initState();
    _loadAdminLock();
    _checkAdminGate();
    _loadAuth();
    _loadAdminExtras();
  }

  @override
  void dispose() {
    _passCtrl.dispose();
    _passCtrl.dispose();
    _cupomCodeCtrl.dispose();
    _cupomPctCtrl.dispose();
    _cupomDaysCtrl.dispose();
    _whatsCtrl.dispose();
    _instaCtrl.dispose();
    _faceCtrl.dispose();
    _noticeCtrl.dispose();
    _partnerNameCtrl.dispose();
    _partnerUrlCtrl.dispose();
    _partnerDiscountCtrl.dispose();
    _svcNameCtrl.dispose();
    _svcPriceCtrl.dispose();
    _svcNotesCtrl.dispose();
    super.dispose();
  }

  double _toDouble(String s, double fallback) =>
      double.tryParse(s.trim().replaceAll(',', '.')) ?? fallback;

  void _snack(String msg) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(msg)));
  }

  // ---------------- AUTH ----------------
  Future<void> _loadAuth() async {
    final sp = await SharedPreferences.getInstance();
    final savedPass = sp.getString(_kAdminPass);
    if (savedPass == null || savedPass.trim().isEmpty) {
      await sp.setString(_kAdminPass, '1234');
    }
    final ok = sp.getBool(_kAdminAuthed) ?? false;
    if (!mounted) return;
    setState(() {
      _authed = ok;
      _loadingAuth = false;
    });
  }

  Future<void> _login() async {
    final sp = await SharedPreferences.getInstance();
    final savedPass = (sp.getString(_kAdminPass) ?? '1234').trim();
    final typed = _passCtrl.text.trim();
    if (typed == savedPass) {
      await sp.setBool(_kAdminAuthed, true);
      if (!mounted) return;
      setState(() => _authed = true);
      _snack("Admin liberado ✅");
    } else {
      _snack("Senha incorreta ❌");
    }
  }

  Future<void> _logout() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setBool(_kAdminAuthed, false);
    if (!mounted) return;
    setState(() => _authed = false);
    _snack("Saiu do Admin.");
  }

  Future<void> _setPassword(String newPass) async {
    final sp = await SharedPreferences.getInstance();
    final v = newPass.trim();
    if (v.length < 4) {
      _snack("Senha muito curta (mín 4).");
      return;
    }
    await sp.setString(_kAdminPass, v);
    _snack("Senha alterada ✅");
  }

  Future<void> _resetPassword1234() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kAdminPass, '1234');
    _snack("Senha resetada para 1234 ✅");
  }

  // ---------------- LOAD EXTRAS ----------------
  Future<void> _loadAdminExtras() async {
    final sp = await SharedPreferences.getInstance();

    _cupomEnabled = sp.getBool(_kCupomEnabled) ?? false;
    _cupomCodeCtrl.text = sp.getString(_kCupomCode) ?? "FG10";
    _cupomPctCtrl.text = sp.getString(_kCupomPct) ?? "10";
    final endAt = sp.getInt(_kCupomEndAt);
    if (endAt != null) {
      final msLeft = endAt - DateTime.now().millisecondsSinceEpoch;
      final d = (msLeft / (1000*60*60*24)).ceil();
      if (d > 0) _cupomDaysCtrl.text = d.toString();
    }


    _whatsCtrl.text = sp.getString(_kWhats) ?? "5521997901083";
    _instaCtrl.text = sp.getString(_kInsta) ?? "fg_eletrica_ofc";
    _faceCtrl.text = sp.getString(_kFace) ?? "https://www.facebook.com/share/1CSZ3681VC/";

    _forceWatermark = sp.getBool(_kForceWatermark) ?? false;
    _requireSign = sp.getBool(_kRequireSign) ?? false;

    final notice = sp.getString(_kHomeNotice) ?? "";
    _noticeCtrl.text = notice;
    _noticeEnabled = notice.trim().isNotEmpty;

    // parceiros
    try {
      final raw = sp.getString(_kPartnersJson) ?? "[]";
      final j = jsonDecode(raw);
      if (j is List) {
        _partners = j.map((e) => (e as Map).cast<String, dynamic>()).toList();
      }
    } catch (_) {
      _partners = [];
    }

    // tabela preços
    try {
      final raw = sp.getString(_kServicePricesJson) ?? "[]";
      final j = jsonDecode(raw);
      if (j is List) {
        _servicePrices = j.map((e) => (e as Map).cast<String, dynamic>()).toList();
      }
    } catch (_) {
      _servicePrices = [];
    }

    if (!mounted) return;
    setState(() {});
  }

  Future<void> _saveCupom() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setBool(_kCupomEnabled, _cupomEnabled);
    await sp.setString(_kCupomCode, _cupomCodeCtrl.text.trim());
    await sp.setString(_kCupomPct, _cupomPctCtrl.text.trim());
    
    
    
    await sp.setString(_kCupomUntil, _cupomUntilCtrl.text.trim());
// expiração do cupom
    final days = double.tryParse(_cupomDaysCtrl.text.trim().replaceAll(',', '.')) ?? 7;
    final endAt = DateTime.now().add(Duration(days: days.round())).millisecondsSinceEpoch;
    await sp.setInt(_kCupomEndAt, endAt);
if (!mounted) return;
    Navigator.of(context).pushNamedAndRemoveUntil(AppRoutes.homeMain, (r) => false);
_snack("Cupom salvo ✅");
    if (!mounted) return;
    Navigator.of(context).popUntil((r) => r.isFirst);
  }


  Future<void> _saveLinks() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kWhats, _whatsCtrl.text.trim());
    await sp.setString(_kInsta, _instaCtrl.text.trim());
    await sp.setString(_kFace, _faceCtrl.text.trim());
    _snack("Links salvos ✅");
  }

  Future<void> _saveFlags() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setBool(_kForceWatermark, _forceWatermark);
    await sp.setBool(_kRequireSign, _requireSign);
    _snack("Flags salvas ✅");
  }

  Future<void> _saveNotice() async {
    final sp = await SharedPreferences.getInstance();
    final txt = _noticeCtrl.text.trim();
    await sp.setString(_kHomeNotice, txt);
    setState(() => _noticeEnabled = txt.isNotEmpty);
    _snack("Aviso salvo ✅");
  }

  // ---------------- PARCEIROS ----------------
  Future<void> _savePartners() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kPartnersJson, jsonEncode(_partners));
    _snack("Parceiros salvos ✅");
  }

  void _addPartner() {
    final name = _partnerNameCtrl.text.trim();
    final url = _partnerUrlCtrl.text.trim();
    final disc = _partnerDiscountCtrl.text.trim();
    if (name.isEmpty || url.isEmpty) {
      _snack("Preencha nome e link.");
      return;
    }
    setState(() {
      _partners.insert(0, {"name": name, "url": url, "discount": disc});
      _partnerNameCtrl.clear();
      _partnerUrlCtrl.clear();
      _partnerDiscountCtrl.clear();
    });
    _savePartners();
  }

  void _removePartner(int i) {
    setState(() => _partners.removeAt(i));
    _savePartners();
  }

  // ---------------- TABELA PREÇOS ----------------
  Future<void> _saveServicePrices() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kServicePricesJson, jsonEncode(_servicePrices));
    _snack("Tabela de preços salva ✅");
  }

  void _seedServicePrices() {
    final seed = <Map<String, dynamic>>[
      {"name": "Troca de fiação (por cômodo)", "price": 450.0, "notes": "Base por cômodo (ajuste por pontos)"},
      {"name": "Circuito ar-condicionado", "price": 380.0, "notes": "Inclui dimensionamento e passagem simples"},
      {"name": "Instalação de disjuntor", "price": 180.0, "notes": "Sem materiais"},
      {"name": "Padrão ENEL 127V", "price": 1200.0, "notes": "Serviço base (varia por poste/caixa)"},
      {"name": "Padrão ENEL 220V", "price": 1450.0, "notes": "Serviço base (varia por poste/caixa)"},
      {"name": "Instalação de chuveiro", "price": 150.0, "notes": "Sem materiais"},
      {"name": "Tomada extra", "price": 120.0, "notes": "Por ponto"},
      {"name": "Ponto de luz", "price": 140.0, "notes": "Por ponto"},
    ];
    setState(() => _servicePrices = seed);
    _saveServicePrices();
  }

  void _addServicePrice() {
    final name = _svcNameCtrl.text.trim();
    final price = _toDouble(_svcPriceCtrl.text, -1);
    final notes = _svcNotesCtrl.text.trim();
    if (name.isEmpty || price < 0) {
      _snack("Preencha nome e preço.");
      return;
    }
    setState(() {
      _servicePrices.insert(0, {"name": name, "price": price, "notes": notes});
      _svcNameCtrl.clear();
      _svcPriceCtrl.clear();
      _svcNotesCtrl.clear();
    });
    _saveServicePrices();
  }

  void _removeServicePrice(int i) {
    setState(() => _servicePrices.removeAt(i));
    _saveServicePrices();
  }

  // ---------------- RESET GERAL ----------------
  Future<void> _factoryReset() async {
    final sp = await SharedPreferences.getInstance();
    final pass = sp.getString(_kAdminPass) ?? "1234";
    await sp.clear();
    await sp.setString(_kAdminPass, pass);
    await sp.setBool(_kAdminAuthed, true);
    _snack("Reset feito ✅");
    await _loadAdminExtras();
    if (!mounted) return;
    setState(() {});
  }

  // ---------------- PRO/TRIAL ----------------
  Future<_AdminStatus> _loadPro() async {
    final proDev = await ProAccess.getProDev();
    final until = await ProAccess.getTrialUntilMs();
    final left = await ProAccess.trialRemaining();
    final has = await ProAccess.hasProAccessNow();
    return _AdminStatus(
      proDev: proDev,
      trialUntilMs: until,
      trialRemaining: left,
      hasAccessNow: has,
    );
  }

  String _fmtDate(int ms) {
    final dt = DateTime.fromMillisecondsSinceEpoch(ms);
    String two(int n) => n.toString().padLeft(2, '0');
    return '${two(dt.day)}/${two(dt.month)}/${dt.year} ${two(dt.hour)}:${two(dt.minute)}:${two(dt.second)}';
  }

  Widget _cardBox({required Widget child}) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: card,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: border),
      ),
      child: child,
    );
  }

  
  Widget _btn({required String label, required Future<void> Function() onTap, bool danger = false}) {
    return Expanded(
      child: ElevatedButton(
        onPressed: () async {
          await onTap();
        },
        style: ElevatedButton.styleFrom(
          backgroundColor: danger ? Colors.redAccent : gold,
          foregroundColor: danger ? Colors.white : Colors.black,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
        ),
        child: Text(label, style: const TextStyle(fontWeight: FontWeight.w900)),
      ),
    );
  }

  InputDecoration _dec(String label) => InputDecoration(
        labelText: label,
        filled: true,
        fillColor: const Color(0xFF0E1117),
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(14)),
      );
  Widget _adminGate({required Widget child}) {
    if (!_adminLockLoaded) {
      return const Scaffold(body: Center(child: CircularProgressIndicator()));
    }
    if (_adminUnlocked) return child;

    final page = Scaffold(
      appBar: AppBar(title: const Text("Admin (senha)")),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Container(
          padding: const EdgeInsets.all(14),
          decoration: BoxDecoration(
            color: const Color(0xFF141A22),
            borderRadius: BorderRadius.circular(18),
            border: Border.all(color: const Color(0xFF2B2F3A)),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                _adminPassSaved.isEmpty ? "Defina uma senha do Admin" : "Digite a senha do Admin",
                style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 16),
              ),
              const SizedBox(height: 10),
              TextField(
                controller: _passCtrl,
                obscureText: true,
                decoration: const InputDecoration(
                  labelText: "Senha",
                  filled: true,
                  fillColor: Color(0xFF0F141B),
                  border: OutlineInputBorder(),
                ),
              ),
              const SizedBox(height: 10),
              SizedBox(
                      width: double.infinity,
                      height: 46,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: gold,
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                        ),
                        onPressed: _saveCupom,
                        child: const Text("Salvar cupom", style: TextStyle(fontWeight: FontWeight.w900)),
                      ),
                    ),
                    const SizedBox(height: 14),
                    SizedBox(
                      width: double.infinity,
                      height: 46,
                      child: OutlinedButton(
                        style: OutlinedButton.styleFrom(
                          foregroundColor: Colors.redAccent,
                          side: const BorderSide(color: Colors.redAccent),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                        ),
                        onPressed: () async {
                          final sp = await SharedPreferences.getInstance();
                          await sp.setBool(_kAdminUnlocked, false);
                          if (!mounted) return;
                          Navigator.of(context).pop();
                        },
                        child: const Text("Bloquear Admin agora", style: TextStyle(fontWeight: FontWeight.w900)),
                      ),
                    ),
                    
              ),

                    ),
                  ],
                ),
              ),

              const SizedBox(height: 14),

              _cardBox(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Links do app',
                        style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
                    const SizedBox(height: 10),
                    TextField(controller: _whatsCtrl, decoration: _dec("WhatsApp (números)")),
                    const SizedBox(height: 10),
                    TextField(controller: _instaCtrl, decoration: _dec("Instagram (sem @)")),
                    const SizedBox(height: 10),
                    TextField(controller: _faceCtrl, decoration: _dec("Facebook URL")),
                    const SizedBox(height: 10),
                    SizedBox(
                      width: double.infinity,
                      height: 46,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: gold,
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                        ),
                        onPressed: _saveLinks,
                        child: const Text("Salvar links", style: TextStyle(fontWeight: FontWeight.w900)),
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 14),

              _cardBox(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Flags (testes)',
                        style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
                    SwitchListTile(
                      contentPadding: EdgeInsets.zero,
                      value: _forceWatermark,
                      onChanged: (v) => setState(() => _forceWatermark = v),
                      title: const Text("Forçar marca d'água no PDF", style: TextStyle(color: Colors.white)),
                    ),
                    SwitchListTile(
                      contentPadding: EdgeInsets.zero,
                      value: _requireSign,
                      onChanged: (v) => setState(() => _requireSign = v),
                      title: const Text("Exigir assinatura p/ PDF", style: TextStyle(color: Colors.white)),
                    ),
                    const SizedBox(height: 10),
                    SizedBox(
                      width: double.infinity,
                      height: 46,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: gold,
                          foregroundColor: Colors.black,
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                        ),
                        onPressed: _saveFlags,
                        child: const Text("Salvar flags", style: TextStyle(fontWeight: FontWeight.w900)),
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 14),

              _cardBox(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Senha do Admin',
                        style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
                    const SizedBox(height: 10),
                    TextField(
                      obscureText: true,
                      decoration: _dec("Nova senha (mín 4)"),
                      onSubmitted: (v) => _setPassword(v),
                    ),
                    const SizedBox(height: 10),
                    Row(
                      children: [
                        _btn(label: "Resetar p/ 1234", danger: true, onTap: _resetPassword1234),
                        const SizedBox(width: 10),
                        _btn(label: "OK", onTap: () async { _snack("Digite a senha e aperte Enter ✅"); }),
                      ],
                    ),
                  ],
                ),
              ),
            ],
          );
        },
      ),
    );
  
    return _adminGate(child: const SizedBox.shrink());
}
}

class _AdminStatus {
  final bool proDev;
  final int? trialUntilMs;
  final Duration trialRemaining;
  final bool hasAccessNow;

  _AdminStatus({
    required this.proDev,
    required this.trialUntilMs,
    required this.trialRemaining,
    required this.hasAccessNow,
  });
}
