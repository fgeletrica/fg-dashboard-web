import 'dart:convert';

import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

import '../../services/pro_access.dart';

class AdminScreen extends StatefulWidget {
  const AdminScreen({super.key});

  @override
  State<AdminScreen> createState() => _AdminScreenState();
}

class _AdminScreenState extends State<AdminScreen> {
  static const String _kAdminPin = 'admin_pin_v1';
  String _pin = '2442';

  final _pinAtualCtrl = TextEditingController();
  final _pinNovoCtrl = TextEditingController();

  Future<void> _loadPin() async {
    final sp = await SharedPreferences.getInstance();
    final saved = (sp.getString(_kAdminPin) ?? '').trim();
    if (saved.isEmpty) {
      await sp.setString(_kAdminPin, '2442');
      _pin = '2442';
    } else {
      _pin = saved;
    }
    if (mounted) setState(() {});
  }

  Future<void> _changePin() async {
    final atual = _pinAtualCtrl.text.trim();
    final novo = _pinNovoCtrl.text.trim();

    if (atual != _pin) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Senha atual incorreta ‚ùå')),
      );
      return;
    }
    if (novo.length < 4) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Nova senha precisa ter no m√≠nimo 4 d√≠gitos.')),
      );
      return;
    }

    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kAdminPin, novo);
    _pin = novo;
    _pinAtualCtrl.clear();
    _pinNovoCtrl.clear();

    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Senha alterada ‚úÖ')),
    );
    setState(() {});
  }

  // ----------------- KEYS (compat√≠vel com o que o app j√° usa) -----------------
  static const _kAdminAuthed = 'admin_authed_v1';
  static const _kAdminPass = 'admin_pass_v1';

  static const _kCupomEnabled = 'cupom_enabled_v1';
  static const _kCupomCode = 'cupom_code_v1';
  static const _kCupomPct = 'cupom_pct_v1';
  static const _kCupomEndAtMs = 'cupom_endat_ms_v1'; // expira√ß√£o do cupom

  static const _kHomeNotice = 'home_notice_v1';

  static const _kLinksWhats = 'links_whats_v1';
  static const _kLinksInsta = 'links_insta_v1';
  static const _kLinksFace = 'links_face_v1';

  static const _kPartnersJson = 'partners_json_v1';
  static const _kServicePricesJson = 'service_prices_json_v1';

  // ----------------- SENHA -----------------
  bool _loadingAuth = true;
  bool _authed = false;

  final _passCtrl = TextEditingController();
  final _newPassCtrl = TextEditingController();

  // ----------------- CUPOM -----------------
  bool _cupomEnabled = false;
  final _cupomCodeCtrl = TextEditingController(text: 'FG10');
  final _cupomPctCtrl = TextEditingController(text: '10');
  final _cupomDaysCtrl = TextEditingController(text: '7');
  int? _cupomEndAtMs;

  // ----------------- AVISO HOME -----------------
  final _noticeCtrl = TextEditingController();

  // ----------------- LINKS -----------------
  final _whatsCtrl = TextEditingController();
  final _instaCtrl = TextEditingController();
  final _faceCtrl = TextEditingController();

  // ----------------- PARCEIROS -----------------
  final _partnerNameCtrl = TextEditingController();
  final _partnerUrlCtrl = TextEditingController();
  final _partnerDiscountCtrl = TextEditingController(text: '10');
  List<Map<String, dynamic>> _partners = [];

  // ----------------- PRE√áOS DE SERVI√áOS -----------------
  final _svcNameCtrl = TextEditingController();
  final _svcPriceCtrl = TextEditingController();
  final _svcNotesCtrl = TextEditingController();
  List<Map<String, dynamic>> _servicePrices = [];

  // UI
  static const _bg = Color(0xFF0E1116);
  static const _card = Color(0xFF141A22);
  static const _border = Color(0xFF2B2F3A);
  static const _gold = Color(0xFFFFC857);

  @override
  void initState() {
    super.initState();
    
    _loadPin();
_loadAll();
  }

  @override
  void dispose() {
    
    _pinAtualCtrl.dispose();
    _pinNovoCtrl.dispose();
_passCtrl.dispose();
    _newPassCtrl.dispose();

    _cupomCodeCtrl.dispose();
    _cupomPctCtrl.dispose();
    _cupomDaysCtrl.dispose();

    _noticeCtrl.dispose();

    _whatsCtrl.dispose();
    _instaCtrl.dispose();
    _faceCtrl.dispose();

    _partnerNameCtrl.dispose();
    _partnerUrlCtrl.dispose();
    _partnerDiscountCtrl.dispose();

    _svcNameCtrl.dispose();
    _svcPriceCtrl.dispose();
    _svcNotesCtrl.dispose();

    super.dispose();
  }

  Future<void> _loadAll() async {
    final sp = await SharedPreferences.getInstance();

    final pass = (sp.getString(_kAdminPass) ?? '').trim();
    if (pass.isEmpty) {
      await sp.setString(_kAdminPass, '2468'); // padr√£o
    }
    final ok = sp.getBool(_kAdminAuthed) ?? false;

    _cupomEnabled = sp.getBool(_kCupomEnabled) ?? false;
    _cupomCodeCtrl.text = (sp.getString(_kCupomCode) ?? 'FG10').trim();
    _cupomPctCtrl.text = (sp.getString(_kCupomPct) ?? '10').trim();
    _cupomEndAtMs = sp.getInt(_kCupomEndAtMs);

    _noticeCtrl.text = (sp.getString(_kHomeNotice) ?? '').trim();

    _whatsCtrl.text = (sp.getString(_kLinksWhats) ?? '').trim();
    _instaCtrl.text = (sp.getString(_kLinksInsta) ?? '').trim();
    _faceCtrl.text = (sp.getString(_kLinksFace) ?? '').trim();

    _partners = _decodeListMap(sp.getString(_kPartnersJson)) ?? [];
    _servicePrices = _decodeListMap(sp.getString(_kServicePricesJson)) ?? _seedServicePrices();

    if (!mounted) return;
    setState(() {
      _authed = ok;
      _loadingAuth = false;
    });
  }

  List<Map<String, dynamic>>? _decodeListMap(String? raw) {
    if (raw == null || raw.trim().isEmpty) return null;
    try {
      final j = jsonDecode(raw);
      if (j is List) {
        return j.map((e) => (e as Map).map((k, v) => MapEntry(k.toString(), v))).toList();
      }
    } catch (_) {}
    return null;
  }

  void _snack(String msg) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(msg)));
  }

  InputDecoration _dec(String label) => InputDecoration(
        labelText: label,
        filled: true,
        fillColor: _card,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(14)),
      );

  Widget _box({required Widget child}) {
    return Container(
      margin: const EdgeInsets.only(bottom: 14),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: _card,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: _border),
      ),
      child: child,
    );
  }

  // ----------------- AUTH -----------------
  Future<void> _login() async {
    final sp = await SharedPreferences.getInstance();
    final saved = (sp.getString(_kAdminPass) ?? '2468').trim();
    final typed = _passCtrl.text.trim();

    if (typed == saved) {
      await sp.setBool(_kAdminAuthed, true);
      if (!mounted) return;
      setState(() => _authed = true);
      _snack('Admin liberado ‚úÖ');
      return;
    }
    _snack('Senha incorreta ‚ùå');
  }

  Future<void> _logout() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setBool(_kAdminAuthed, false);
    if (!mounted) return;
    setState(() => _authed = false);
    _snack('Admin bloqueado ‚úÖ');
  }

  Future<void> _setPassword() async {
    final v = _newPassCtrl.text.trim();
    if (v.length < 4) {
      _snack('Senha muito curta (m√≠n 4).');
      return;
    }
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kAdminPass, v);
    _newPassCtrl.clear();
    _snack('Senha alterada ‚úÖ');
  }

  Future<void> _resetPassword1234() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kAdminPass, '1234');
    _snack('Senha resetada para 1234 ‚úÖ');
  }

  // ----------------- CUPOM -----------------
  String _fmtLeft(int msLeft) {
    if (msLeft <= 0) return 'expirado';
    final s = (msLeft / 1000).floor();
    final d = s ~/ 86400;
    final h = (s % 86400) ~/ 3600;
    final m = (s % 3600) ~/ 60;
    final ss = s % 60;
    return '${d}d ${h}h ${m}m ${ss}s';
  }

  Future<void> _saveCupom() async {
    final sp = await SharedPreferences.getInstance();
    final code = _cupomCodeCtrl.text.trim();
    final pct = _cupomPctCtrl.text.trim();

    // üî• aqui √© o ponto: dias manuais SEMPRE sobrescrevem a expira√ß√£o
    final vDays = int.tryParse(_cupomDaysCtrl.text.trim());
    if (vDays != null && vDays > 0) {
      _cupomEndAtMs = DateTime.now().add(Duration(days: vDays)).millisecondsSinceEpoch;
    }

    await sp.setBool(_kCupomEnabled, _cupomEnabled);
    await sp.setString(_kCupomCode, code);
    await sp.setString(_kCupomPct, pct);

    if (_cupomEndAtMs != null) {
      await sp.setInt(_kCupomEndAtMs, _cupomEndAtMs!);
    } else {
      await sp.remove(_kCupomEndAtMs);
    }

    _snack('Cupom salvo ‚úÖ');
    if (!mounted) return;
    setState(() {});
  }

  Future<void> _expireCupomNow() async {
    final sp = await SharedPreferences.getInstance();
    _cupomEnabled = false;
    _cupomEndAtMs = null;
    await sp.setBool(_kCupomEnabled, false);
    await sp.remove(_kCupomEndAtMs);
    _snack('Cupom expirado agora ‚úÖ');
    if (!mounted) return;
    setState(() {});
  }

  Future<void> _extendCupomDays(int days) async {
    _cupomDaysCtrl.text = days.toString();
    _cupomEndAtMs = DateTime.now().add(Duration(days: days)).millisecondsSinceEpoch;
    await _saveCupom();
    if (!mounted) return;
    setState(() {});
  }

  // ----------------- HOME NOTICE -----------------
  Future<void> _saveNotice() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kHomeNotice, _noticeCtrl.text.trim());
    _snack('Aviso salvo ‚úÖ');
  }

  // ----------------- LINKS -----------------
  Future<void> _saveLinks() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kLinksWhats, _whatsCtrl.text.trim());
    await sp.setString(_kLinksInsta, _instaCtrl.text.trim());
    await sp.setString(_kLinksFace, _faceCtrl.text.trim());
    _snack('Links salvos ‚úÖ');
  }

  // ----------------- PARCEIROS -----------------
  Future<void> _savePartners() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kPartnersJson, jsonEncode(_partners));
  }

  Future<void> _addPartner() async {
    final name = _partnerNameCtrl.text.trim();
    final url = _partnerUrlCtrl.text.trim();
    final disc = double.tryParse(_partnerDiscountCtrl.text.replaceAll(',', '.').trim()) ?? 0;

    if (name.isEmpty) {
      _snack('Nome do parceiro vazio.');
      return;
    }

    _partners.add({"name": name, "url": url, "discount": disc});
    _partnerNameCtrl.clear();
    _partnerUrlCtrl.clear();

    await _savePartners();
    _snack('Parceiro adicionado ‚úÖ');
    setState(() {});
  }

  Future<void> _removePartner(int i) async {
    _partners.removeAt(i);
    await _savePartners();
    setState(() {});
  }

  // ----------------- SERVI√áOS -----------------
  List<Map<String, dynamic>> _seedServicePrices() {
    return [
      {"name": "Padr√£o ENEL 127V", "price": 780.0, "notes": "Base (varia por poste/caixa)"},
      {"name": "Padr√£o ENEL 220V", "price": 950.0, "notes": "Base (varia por poste/caixa)"},
      {"name": "Instala√ß√£o de chuveiro", "price": 180.0, "notes": "Sem material"},
      {"name": "Troca de disjuntor", "price": 120.0, "notes": "Sem material"},
      {"name": "Tomada/Interruptor (un)", "price": 60.0, "notes": ""},
      {"name": "Ponto de luz (un)", "price": 90.0, "notes": ""},
      {"name": "Ventilador de teto", "price": 220.0, "notes": ""},
      {"name": "Visita t√©cnica", "price": 80.0, "notes": ""},
    ];
  }

  Future<void> _saveServicePrices() async {
    final sp = await SharedPreferences.getInstance();
    await sp.setString(_kServicePricesJson, jsonEncode(_servicePrices));
  }

  Future<void> _addServicePrice() async {
    final name = _svcNameCtrl.text.trim();
    final price = double.tryParse(_svcPriceCtrl.text.replaceAll(',', '.').trim()) ?? 0.0;
    final notes = _svcNotesCtrl.text.trim();

    if (name.isEmpty) {
      _snack('Nome do servi√ßo vazio.');
      return;
    }

    _servicePrices.add({"name": name, "price": price, "notes": notes});
    _svcNameCtrl.clear();
    _svcPriceCtrl.clear();
    _svcNotesCtrl.clear();

    await _saveServicePrices();
    _snack('Servi√ßo adicionado ‚úÖ');
    setState(() {});
  }

  Future<void> _removeServicePrice(int i) async {
    _servicePrices.removeAt(i);
    await _saveServicePrices();
    setState(() {});
  }

  Future<void> _applyMultiplier(double mul) async {
    for (final s in _servicePrices) {
      final v = (s["price"] is num) ? (s["price"] as num).toDouble() : 0.0;
      s["price"] = double.parse((v * mul).toStringAsFixed(2));
    }
    await _saveServicePrices();
    setState(() {});
    _snack('Pre√ßos atualizados (x${mul.toStringAsFixed(2)}) ‚úÖ');
  }

  // ----------------- BUILD -----------------
  @override
  Widget build(BuildContext context) {
    if (_loadingAuth) {
      retconst SizedBox.shrink(),
              ),
              const SizedBox(height: 10),
              TextField(
                controller: _passCtrl,
                obscureText: true,
                decoration: _dec('Digite a senha'),
              ),
              const SizedBox(height: 12),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _gold,
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: _login,
                  child: const Text('Entrar', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
              const SizedBox(height: 10),
              Text(
                "Padr√£o: 2468 (ou use Reset 1234).",
                style: TextStyle(color: Colors.white.withOpacity(.70)),
              ),
            ],
          ),
        ),
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Trocar senha (Admin)',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900)),
              const SizedBox(height: 10),
              TextField(
                controller: _newPassCtrl,
                obscureText: true,
                decoration: _dec('Nova senha (m√≠n 4)'),
              ),
              const SizedBox(height: 10),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: _setPassword,
                      style: OutlinedButton.styleFrom(
                        foregroundColor: _gold,
                        side: BorderSide(color: _gold.withOpacity(.7)),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Salvar nova senha', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: OutlinedButton(
                      onPressed: _resetPassword1234,
                      style: OutlinedButton.styleFrom(
                        foregroundColor: Colors.redAccent,
                        side: const BorderSide(color: Colors.redAccent),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Reset 1234', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildAdmin() {
    final nowMs = DateTime.now().millisecondsSinceEpoch;
    final endAt = _cupomEndAtMs;
    final msLeft = (endAt == null) ? null : (endAt - nowMs);

    final cupomStatus = () {
      if (!_cupomEnabled || _cupomCodeCtrl.text.trim().isEmpty) return 'Cupom desativado';
      if (endAt == null) return 'Cupom ativo (sem expira√ß√£o definida)';
      if ((msLeft ?? 0) <= 0) return 'Cupom expirado';
      return 'Expira em: ${_fmtLeft(msLeft!)}';
    }();

    return ListView(
      padding: const EdgeInsets.all(16),
      children: [
        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Cupom / Promo√ß√£o',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              SwitchListTile(
                contentPadding: EdgeInsets.zero,
                value: _cupomEnabled,
                onChanged: (v) => setState(() => _cupomEnabled = v),
                title: const Text('Ativar cupom', style: TextStyle(color: Colors.white)),
              ),
              TextField(controller: _cupomCodeCtrl, decoration: _dec('C√≥digo (ex: FG10)')),
              const SizedBox(height: 10),
              TextField(
                controller: _cupomPctCtrl,
                keyboardType: const TextInputType.numberWithOptions(decimal: true),
                decoration: _dec('Desconto (%) ‚Äî ex: 10'),
              ),
              const SizedBox(height: 10),
              TextField(
                controller: _cupomDaysCtrl,
                keyboardType: TextInputType.number,
                decoration: _dec('Dias para expirar (ex: 2)'),
              ),
              const SizedBox(height: 10),
              Text(cupomStatus, style: TextStyle(color: Colors.white.withOpacity(.80), fontWeight: FontWeight.w700)),
              const SizedBox(height: 10),
              Row(
                children: [
                  Expanded(
                    child: ElevatedButton(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: _gold,
                        foregroundColor: Colors.black,
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      onPressed: _saveCupom,
                      child: const Text('Salvar cupom', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: OutlinedButton(
                      onPressed: _expireCupomNow,
                      style: OutlinedButton.styleFrom(
                        foregroundColor: Colors.redAccent,
                        side: const BorderSide(color: Colors.redAccent),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Expirar agora', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 10),
              Wrap(
                spacing: 10,
                runSpacing: 10,
                children: [
                  OutlinedButton(
                    onPressed: () => _extendCupomDays(1),
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('+1 dia'),
                  ),
                  OutlinedButton(
                    onPressed: () => _extendCupomDays(3),
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('+3 dias'),
                  ),
                  OutlinedButton(
                    onPressed: () => _extendCupomDays(7),
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('+7 dias'),
                  ),
                  OutlinedButton(
                    onPressed: () => _extendCupomDays(30),
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('+30 dias'),
                  ),
                ],
              ),
            ],
          ),
        ),

        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Aviso na Home',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              TextField(
                controller: _noticeCtrl,
                maxLines: 3,
                decoration: _dec('Texto do aviso (vazio remove)'),
              ),
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _gold,
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: _saveNotice,
                  child: const Text('Salvar aviso', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
            ],
          ),
        ),

        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Tabela de pre√ßos (Servi√ßos PRO)',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () async {
                        _servicePrices = _seedServicePrices();
                        await _saveServicePrices();
                        setState(() {});
                        _snack('Tabela base restaurada ‚úÖ');
                      },
                      style: OutlinedButton.styleFrom(
                        foregroundColor: _gold,
                        side: BorderSide(color: _gold.withOpacity(.7)),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Restaurar base', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => _applyMultiplier(0.65),
                      style: OutlinedButton.styleFrom(
                        foregroundColor: Colors.greenAccent,
                        side: const BorderSide(color: Colors.greenAccent),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                      ),
                      child: const Text('Reduzir 35%', style: TextStyle(fontWeight: FontWeight.w900)),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 10),
              TextField(controller: _svcNameCtrl, decoration: _dec('Nome do servi√ßo')),
              const SizedBox(height: 10),
              TextField(
                controller: _svcPriceCtrl,
                keyboardType: const TextInputType.numberWithOptions(decimal: true),
                decoration: _dec('Pre√ßo (R\$)'),
              ),
              const SizedBox(height: 10),
              TextField(controller: _svcNotesCtrl, decoration: _dec('Observa√ß√µes (opcional)')),
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _gold,
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: _addServicePrice,
                  child: const Text('Adicionar servi√ßo', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
              const SizedBox(height: 12),
              ..._servicePrices.asMap().entries.map((e) {
                final i = e.key;
                final s = e.value;
                final name = (s["name"] ?? "").toString();
                final price = (s["price"] is num) ? (s["price"] as num).toDouble() : 0.0;
                final notes = (s["notes"] ?? "").toString();

                return Container(
                  margin: const EdgeInsets.only(bottom: 10),
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: const Color(0xFF10151D),
                    borderRadius: BorderRadius.circular(14),
                    border: Border.all(color: _border),
                  ),
                  child: Row(
                    children: [
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900)),
                            const SizedBox(height: 4),
                            Text('R\$ ${price.toStringAsFixed(2)}',
                                style: TextStyle(color: Colors.white.withOpacity(.75), fontWeight: FontWeight.w700)),
                            if (notes.trim().isNotEmpty)
                              Padding(
                                padding: const EdgeInsets.only(top: 4),
                                child: Text(notes, style: TextStyle(color: Colors.white.withOpacity(.60))),
                              ),
                          ],
                        ),
                      ),
                      IconButton(
                        onPressed: () => _removeServicePrice(i),
                        icon: const Icon(Icons.delete, color: Colors.redAccent),
                      ),
                    ],
                  ),
                );
              }),
            ],
          ),
        ),

        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Links do app',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              TextField(controller: _whatsCtrl, decoration: _dec('WhatsApp (n√∫meros)')),
              const SizedBox(height: 10),
              TextField(controller: _instaCtrl, decoration: _dec('Instagram (sem @)')),
              const SizedBox(height: 10),
              TextField(controller: _faceCtrl, decoration: _dec('Facebook URL')),
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _gold,
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: _saveLinks,
                  child: const Text('Salvar links', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
            ],
          ),
        ),

        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('PRO / Trial (DEV)',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              Wrap(
                spacing: 10,
                runSpacing: 10,
                children: [
                  OutlinedButton(
                    onPressed: () async {
                      await ProAccess.setProDev(true);
                      _snack('PRO (DEV) ativado');
                      setState(() {});
                    },
                    style: OutlinedButton.styleFrom(foregroundColor: _gold, side: BorderSide(color: _gold.withOpacity(.6))),
                    child: const Text('Ativar PRO (DEV)'),
                  ),
                  OutlinedButton(
                    onPressed: () async {
                      await ProAccess.setProDev(false);
                      _snack('PRO (DEV) desativado');
                      setState(() {});
                    },
                    style: OutlinedButton.styleFrom(foregroundColor: Colors.redAccent, side: const BorderSide(color: Colors.redAccent)),
                    child: const Text('Desativar PRO (DEV)'),
                  ),
                  OutlinedButton(
                    onPressed: () async {
                      await ProAccess.startTrial(duration: const Duration(minutes: 10));
                      _snack('Trial 10 min ativado ‚úÖ');
                      setState(() {});
                    },
                    style: OutlinedButton.styleFrom(foregroundColor: Colors.greenAccent, side: const BorderSide(color: Colors.greenAccent)),
                    child: const Text('Trial 10 min'),
                  ),
                  OutlinedButton(
                    onPressed: () async {
                      await ProAccess.resetTrial();
                      _snack('Trial resetado ‚úÖ');
                      setState(() {});
                    },
                    style: OutlinedButton.styleFrom(foregroundColor: Colors.redAccent, side: const BorderSide(color: Colors.redAccent)),
                    child: const Text('Reset Trial'),
                  ),
                ],
              ),
            ],
          ),
        ),

        _box(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Seguran√ßa',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 46,
                child: OutlinedButton(
                  style: OutlinedButton.styleFrom(
                    foregroundColor: Colors.redAccent,
                    side: const BorderSide(color: Colors.redAccent),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  ),
                  onPressed: () async {
                    await _logout();
                    if (!mounted) return;
                    Navigator.of(context).pop();
                  },
                  child: const Text('Bloquear Admin agora', style: TextStyle(fontWeight: FontWeight.w900)),
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }
}
