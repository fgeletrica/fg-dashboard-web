import 'package:flutter/material.dart';
import '../../services/pro_access.dart';

class AdminScreen extends StatefulWidget {
  const AdminScreen({super.key});

  @override
  State<AdminScreen> createState() => _AdminScreenState();
}

class _AdminScreenState extends State<AdminScreen> {
  final bg = const Color(0xFF0E1117);
  final card = const Color(0xFF141A22);
  final border = const Color(0xFF2B2F3A);
  final gold = const Color(0xFFF7C948);

  bool _unlocked = false;
  final _passCtrl = TextEditingController();

  static const String _adminPass = "2468"; // ✅ troque aqui se quiser

  @override
  void dispose() {
    _passCtrl.dispose();
    super.dispose();
  }

  Future<_AdminStatus> _load() async {
    final proDev = await ProAccess.getProDev();
    final until = await ProAccess.getTrialUntilMs();
    final left = await ProAccess.trialRemaining();
    final has = await ProAccess.hasProAccessNow();
    return _AdminStatus(
      proDev: proDev,
      trialUntilMs: until,
      trialRemaining: left,
      hasAccessNow: has,
    );
  }

  String _fmtDate(int ms) {
    final dt = DateTime.fromMillisecondsSinceEpoch(ms);
    String two(int n) => n.toString().padLeft(2, '0');
    return '${two(dt.day)}/${two(dt.month)}/${dt.year} ${two(dt.hour)}:${two(dt.minute)}:${two(dt.second)}';
  }

  Future<void> _snack(String msg) async {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(msg)));
  }

  Widget _btn({
    required String label,
    required Future<void> Function() onTap,
    bool danger = false,
  }) {
    return Expanded(
      child: ElevatedButton(
        onPressed: () async {
          try {
            await onTap();
            if (!mounted) return;
            setState(() {});
          } catch (e) {
            await _snack('Erro: $e');
          }
        },
        style: ElevatedButton.styleFrom(
          backgroundColor: danger ? const Color(0xFFB00020) : gold,
          foregroundColor: danger ? Colors.white : Colors.black,
          padding: const EdgeInsets.symmetric(vertical: 12),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
        ),
        child: Text(label, textAlign: TextAlign.center),
      ),
    );
  }

  Future<void> _askPassword() async {
    _passCtrl.text = "";
    final ok = await showDialog<bool>(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text("Admin"),
        content: TextField(
          controller: _passCtrl,
          obscureText: true,
          decoration: const InputDecoration(labelText: "Senha"),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text("Cancelar")),
          FilledButton(
            onPressed: () {
              Navigator.pop(context, _passCtrl.text.trim() == _adminPass);
            },
            child: const Text("Entrar"),
          )
        ],
      ),
    );

    if (ok == true) {
      setState(() => _unlocked = true);
    } else {
      await _snack("Senha incorreta ❌");
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: bg,
      appBar: AppBar(
        backgroundColor: bg,
        elevation: 0,
        title: const Text('Admin'),
        actions: [
          if (!_unlocked)
            TextButton(
              onPressed: _askPassword,
              child: Text("DESBLOQUEAR", style: TextStyle(color: gold, fontWeight: FontWeight.w900)),
            )
          else
            TextButton(
              onPressed: () => setState(() => _unlocked = false),
              child: Text("BLOQUEAR", style: TextStyle(color: Colors.white70, fontWeight: FontWeight.w900)),
            ),
        ],
      ),
      body: !_unlocked
          ? Center(
              child: Container(
                padding: const EdgeInsets.all(16),
                margin: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: card,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: border),
                ),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.lock, color: gold, size: 40),
                    const SizedBox(height: 10),
                    const Text("Área restrita", style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
                    const SizedBox(height: 8),
                    const Text("Desbloqueie para acessar as funções DEV.", style: TextStyle(color: Colors.white70)),
                    const SizedBox(height: 14),
                    SizedBox(
                      width: double.infinity,
                      height: 48,
                      child: ElevatedButton(
                        onPressed: _askPassword,
                        style: ElevatedButton.styleFrom(backgroundColor: gold, foregroundColor: Colors.black),
                        child: const Text("Desbloquear", style: TextStyle(fontWeight: FontWeight.w900)),
                      ),
                    ),
                  ],
                ),
              ),
            )
          : FutureBuilder<_AdminStatus>(
              future: _load(),
              builder: (context, snap) {
                final s = snap.data;
                final loading = !snap.hasData;

                final proTxt = loading ? '...' : (s!.proDev ? 'SIM' : 'NÃO');
                final hasTxt = loading ? '...' : (s!.hasAccessNow ? 'SIM' : 'NÃO');

                final untilTxt = loading ? '...' : (s!.trialUntilMs == null ? '—' : _fmtDate(s.trialUntilMs!));
                final leftTxt = loading ? '...' : ProAccess.formatDuration(s!.trialRemaining);

                return ListView(
                  padding: const EdgeInsets.all(16),
                  children: [
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: card,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: border),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'PRO / Trial (tempo real)',
                            style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18),
                          ),
                          const SizedBox(height: 10),
                          Text('PRO (DEV): $proTxt', style: const TextStyle(color: Colors.white70)),
                          Text('Acesso agora: $hasTxt', style: const TextStyle(color: Colors.white70)),
                          const SizedBox(height: 10),
                          Text('TrialUntil: $untilTxt', style: const TextStyle(color: Colors.white70)),
                          Text('Restante: $leftTxt', style: const TextStyle(color: Colors.white70)),
                          const SizedBox(height: 14),
                          Row(
                            children: [
                              _btn(
                                label: 'Ativar PRO (DEV)',
                                onTap: () async {
                                  await ProAccess.setProDev(true);
                                  await _snack('PRO (DEV) ativado');
                                },
                              ),
                              const SizedBox(width: 10),
                              _btn(
                                label: 'Desativar PRO (DEV)',
                                danger: true,
                                onTap: () async {
                                  await ProAccess.setProDev(false);
                                  await _snack('PRO (DEV) desativado');
                                },
                              ),
                            ],
                          ),
                          const SizedBox(height: 10),
                          Row(
                            children: [
                              _btn(
                                label: 'Iniciar trial (7d)',
                                onTap: () async {
                                  await ProAccess.startTrial(duration: const Duration(days: 7));
                                  await _snack('Trial iniciado por 7 dias');
                                },
                              ),
                              const SizedBox(width: 10),
                              _btn(
                                label: '+1 dia',
                                onTap: () async {
                                  await ProAccess.extendTrial(const Duration(days: 1));
                                  await _snack('Trial +1 dia');
                                },
                              ),
                            ],
                          ),
                          const SizedBox(height: 10),
                          Row(
                            children: [
                              _btn(
                                label: '+7 dias',
                                onTap: () async {
                                  await ProAccess.extendTrial(const Duration(days: 7));
                                  await _snack('Trial +7 dias');
                                },
                              ),
                              const SizedBox(width: 10),
                              _btn(
                                label: 'Expirar agora',
                                danger: true,
                                onTap: () async {
                                  await ProAccess.expireTrialNow();
                                  await _snack('Trial expirado');
                                },
                              ),
                            ],
                          ),
                          const SizedBox(height: 10),
                          Row(
                            children: [
                              _btn(
                                label: 'Reset Trial',
                                danger: true,
                                onTap: () async {
                                  await ProAccess.resetTrial();
                                  await _snack('Trial resetado (sem data)');
                                },
                              ),
                              const SizedBox(width: 10),
                              Expanded(
                                child: OutlinedButton(
                                  onPressed: () => setState(() {}),
                                  style: OutlinedButton.styleFrom(
                                    foregroundColor: Colors.white,
                                    side: BorderSide(color: border),
                                    padding: const EdgeInsets.symmetric(vertical: 12),
                                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                                  ),
                                  child: const Text('Atualizar status'),
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 14),
                    Container(
                      padding: const EdgeInsets.all(14),
                      decoration: BoxDecoration(
                        color: card,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: border),
                      ),
                      child: Row(
                        children: [
                          Icon(Icons.admin_panel_settings, color: gold),
                          const SizedBox(width: 10),
                          const Expanded(
                            child: Text(
                              'Área DEV fica só aqui.\nPaywall e telas do usuário ficam limpas.',
                              style: TextStyle(color: Colors.white),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                );
              },
            ),
    );
  }
}

class _AdminStatus {
  final bool proDev;
  final int? trialUntilMs;
  final Duration trialRemaining;
  final bool hasAccessNow;

  _AdminStatus({
    required this.proDev,
    required this.trialUntilMs,
    required this.trialRemaining,
    required this.hasAccessNow,
  });
}
