import 'dart:convert';
import 'dart:io';
import 'dart:typed_data';
import 'package:flutter/services.dart';
import 'package:path_provider/path_provider.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;

import '../models/budget_models.dart';
import 'pro_access.dart';
import 'profile_store.dart';

class PdfService {
  static Future<File> generateBudgetPdf({required BudgetDoc doc}) async {
    final pdf = pw.Document();
    final profile = await ProfileStore.get();
    final hasPro = await ProAccess.hasProAccessNow();


    // ✅ Logo do usuário (PRO) — se ele cadastrar uma logo, usamos no PDF
    pw.ImageProvider? userLogo;
    if (hasPro && profile.logoB64.trim().isNotEmpty) {
      try {
        final bytes = base64Decode(profile.logoB64.trim());
        userLogo = pw.MemoryImage(bytes);
      } catch (_) {}
    }

    // logo do app (assets/logo.png)
    pw.ImageProvider? logo;
    // prioridade: logo do usuário (PRO)
    if (userLogo != null) {
      logo = userLogo;
    } else {
      // fallback: logo do app
      try {
        final data = await rootBundle.load('assets/logo.png');
        logo = pw.MemoryImage(data.buffer.asUint8List());
      } catch (_) {}
    }
// assinatura (opcional)
    pw.ImageProvider? signature;
    if (doc.signatureB64 != null && doc.signatureB64!.trim().isNotEmpty) {
      try {
        final bytes = base64Decode(doc.signatureB64!);
        signature = pw.MemoryImage(bytes);
      } catch (_) {}
    }

    pdf.addPage(
      pw.Page(
        pageFormat: PdfPageFormat.a4,
        margin: const pw.EdgeInsets.all(28),
        build: (ctx) {
          return pw.Stack(
            children: [
              pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  // HEADER
                  pw.Row(
                    crossAxisAlignment: pw.CrossAxisAlignment.center,
                    children: [
                      if (logo != null)
                        pw.Container(width: 44, height: 44, child: pw.Image(logo))
                      else
                        pw.Container(
                          width: 44,
                          height: 44,
                          alignment: pw.Alignment.center,
                          decoration: pw.BoxDecoration(
                            border: pw.Border.all(color: PdfColors.amber),
                            borderRadius: pw.BorderRadius.circular(8),
                          ),
                          child: pw.Text('FG', style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                        ),
                      pw.SizedBox(width: 12),
                      pw.Column(
                        crossAxisAlignment: pw.CrossAxisAlignment.start,
                        children: [
                          pw.Text('FG Elétrica — Orçamento',
                              style: pw.TextStyle(fontSize: 18, fontWeight: pw.FontWeight.bold)),
                          pw.Text('Responsável: ${profile.name}', style: const pw.TextStyle(fontSize: 11)),
                          if (profile.company.isNotEmpty)
                            pw.Text('Empresa: ${profile.company}', style: const pw.TextStyle(fontSize: 11)),
                          if (profile.phone.isNotEmpty)
                            pw.Text('Telefone: ${profile.phone}', style: const pw.TextStyle(fontSize: 11)),
                          if (profile.email.isNotEmpty)
                            pw.Text('E-mail: ${profile.email}', style: const pw.TextStyle(fontSize: 11)),
                        ],
                      ),
                    ],
                  ),

                  pw.SizedBox(height: 14),

                  // DADOS DO CLIENTE
                  pw.Container(
                    padding: const pw.EdgeInsets.all(10),
                    decoration: pw.BoxDecoration(
                      border: pw.Border.all(color: PdfColors.grey300),
                      borderRadius: pw.BorderRadius.circular(10),
                    ),
                    child: pw.Column(
                      crossAxisAlignment: pw.CrossAxisAlignment.start,
                      children: [
                        pw.Text(
                          'Cliente: ${doc.clientName.isEmpty ? "—" : doc.clientName}',
                          style: pw.TextStyle(fontWeight: pw.FontWeight.bold),
                        ),
                        pw.Text('Data: ${doc.createdAt.toIso8601String().substring(0, 16).replaceAll("T", " ")}'),
                        if (doc.originTitle != null) pw.Text('Origem do cálculo: ${doc.originTitle}'),
                        if (doc.originPowerW != null && doc.originVoltage != null)
                          pw.Text('Potência: ${doc.originPowerW!.toStringAsFixed(0)} W — Tensão: ${doc.originVoltage} V'),
                      ],
                    ),
                  ),

                  pw.SizedBox(height: 14),

                  // MATERIAIS
                  pw.Text('Materiais', style: pw.TextStyle(fontSize: 13, fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 6),
                  pw.Table.fromTextArray(
                    headers: ['Item', 'Qtd', 'Un', 'R\$ Unit', 'R\$ Total'],
                    headerStyle: pw.TextStyle(fontWeight: pw.FontWeight.bold),
                    data: doc.materials
                        .map((m) => [
                              m.name,
                              m.qty.toStringAsFixed(2),
                              m.unit,
                              m.unitPrice.toStringAsFixed(2),
                              m.total.toStringAsFixed(2),
                            ])
                        .toList(),
                    cellStyle: const pw.TextStyle(fontSize: 10),
                    headerDecoration: const pw.BoxDecoration(color: PdfColors.grey200),
                  ),

                  pw.SizedBox(height: 12),

                  // SERVIÇOS
                  pw.Text('Serviços', style: pw.TextStyle(fontSize: 13, fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 6),
                  pw.Table.fromTextArray(
                    headers: ['Serviço', 'Valor (R\$)'],
                    headerStyle: pw.TextStyle(fontWeight: pw.FontWeight.bold),
                    data: doc.services.map((s) => [s.name, s.price.toStringAsFixed(2)]).toList(),
                    cellStyle: const pw.TextStyle(fontSize: 10),
                    headerDecoration: const pw.BoxDecoration(color: PdfColors.grey200),
                  ),

                  pw.SizedBox(height: 14),
                  pw.Divider(),

                  // TOTAL
                  pw.Row(
                    mainAxisAlignment: pw.MainAxisAlignment.end,
                    children: [
                      pw.Column(
                        crossAxisAlignment: pw.CrossAxisAlignment.end,
                        children: [
                          pw.Text('Subtotal: R\$ ${doc.subtotal.toStringAsFixed(2)}'),
                          pw.Text('Margem: R\$ ${doc.marginAmount.toStringAsFixed(2)}'),
                          pw.Text(
                            'TOTAL: R\$ ${doc.total.toStringAsFixed(2)}',
                            style: pw.TextStyle(fontSize: 14, fontWeight: pw.FontWeight.bold),
                          ),
                        ],
                      ),
                    ],
                  ),

                  pw.SizedBox(height: 18),

                  // ASSINATURA (opcional)
                  pw.Text('Assinatura do cliente', style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 8),
                  pw.Container(
                    height: 90,
                    decoration: pw.BoxDecoration(
                      border: pw.Border.all(color: PdfColors.grey400),
                      borderRadius: pw.BorderRadius.circular(10),
                    ),
                    child: signature == null
                        ? pw.Center(
                            child: pw.Text('Sem assinatura', style: const pw.TextStyle(color: PdfColors.grey700)))
                        : pw.Padding(
                            padding: const pw.EdgeInsets.all(8),
                            child: pw.Image(signature, fit: pw.BoxFit.contain),
                          ),
                  ),

                  pw.SizedBox(height: 20),
                  pw.Divider(),
                  pw.Text(
                    'Documento gerado pelo app FG Elétrica • ${DateTime.now().toString().substring(0, 16)}',
                    style: const pw.TextStyle(fontSize: 9, color: PdfColors.grey700),
                  ),
                ],
              ),

              // Marca d’água + logo no FREE
              if (!hasPro)
                pw.Center(
                  child: pw.Transform.rotate(
                    angle: -0.5,
                    child: pw.Opacity(
                      opacity: 0.18,
                      child: pw.Column(
                        mainAxisSize: pw.MainAxisSize.min,
                        children: [
                          if (logo != null)
                            pw.Container(width: 90, height: 90, child: pw.Image(logo)),
                          pw.SizedBox(height: 8),
                          pw.Text(
                            'FG ELÉTRICA — VERSÃO GRATUITA',
                            style: pw.TextStyle(
                              fontSize: 42,
                              fontWeight: pw.FontWeight.bold,
                              color: PdfColors.grey600,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
            ],
          );
        },
      ),
    );

    final dir = await getTemporaryDirectory();
    final file = File('${dir.path}/orcamento_${doc.id}.pdf');
    await file.writeAsBytes(await pdf.save());
    return file;
  }
}
