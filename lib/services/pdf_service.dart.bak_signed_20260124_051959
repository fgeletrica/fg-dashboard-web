import 'dart:convert';
import 'dart:io';
import 'package:flutter/services.dart';
import 'package:path_provider/path_provider.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;

import '../models/budget_models.dart';
import 'pro_access.dart';
import 'profile_store.dart';

class PdfService {
  static Future<File> generateBudgetPdf({required BudgetDoc doc}) async {
    final pdf = pw.Document();
    final profile = await ProfileStore.get();
    final hasPro = await ProAccess.hasProAccessNow();

    // tenta carregar logo do app (assets/logo.png)
    pw.ImageProvider? logo;
    try {
      final data = await rootBundle.load('assets/logo.png');
      logo = pw.MemoryImage(data.buffer.asUint8List());
    } catch (_) {}

    pw.ImageProvider? signature;
    if (doc.signatureB64 != null && doc.signatureB64!.trim().isNotEmpty) {
      try {
        final bytes = base64Decode(doc.signatureB64!);
        signature = pw.MemoryImage(bytes);
      } catch (_) {}
    }

    pdf.addPage(
      pw.Page(
        pageFormat: PdfPageFormat.a4,
        margin: const pw.EdgeInsets.all(28),
        build: (ctx) {
          return pw.Stack(
            children: [
              pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  pw.Row(
                    crossAxisAlignment: pw.CrossAxisAlignment.center,
                    children: [
                      if (logo != null)
                        pw.Container(
                            width: 44, height: 44, child: pw.Image(logo))
                      else
                        pw.Container(
                          width: 44,
                          height: 44,
                          decoration: pw.BoxDecoration(
                            border: pw.Border.all(color: PdfColors.amber),
                            borderRadius: pw.BorderRadius.circular(8),
                          ),
                          child: pw.Center(
                              child: pw.Text('FG',
                                  style: pw.TextStyle(
                                      fontWeight: pw.FontWeight.bold))),
                        ),
                      pw.SizedBox(width: 12),
                      pw.Column(
                        crossAxisAlignment: pw.CrossAxisAlignment.start,
                        children: [
                          pw.Text('FG Elétrica — Orçamento',
                              style: pw.TextStyle(
                                  fontSize: 18,
                                  fontWeight: pw.FontWeight.bold)),
                          pw.Text('Feito por: ${profile.name}',
                              style: const pw.TextStyle(fontSize: 11)),
                          if (profile.company.isNotEmpty)
                            pw.Text('Empresa: ${profile.company}',
                                style: const pw.TextStyle(fontSize: 11)),
                          if (profile.phone.isNotEmpty)
                            pw.Text('Telefone: ${profile.phone}',
                                style: const pw.TextStyle(fontSize: 11)),
                          if (profile.email.isNotEmpty)
                            pw.Text('E-mail: ${profile.email}',
                                style: const pw.TextStyle(fontSize: 11)),
                        ],
                      ),
                    ],
                  ),
                  pw.SizedBox(height: 14),
                  pw.Container(
                    padding: const pw.EdgeInsets.all(10),
                    decoration: pw.BoxDecoration(
                      border: pw.Border.all(color: PdfColors.grey300),
                      borderRadius: pw.BorderRadius.circular(10),
                    ),
                    child: pw.Column(
                      crossAxisAlignment: pw.CrossAxisAlignment.start,
                      children: [
                        pw.Text(
                            'Cliente: ${doc.clientName.isEmpty ? "—" : doc.clientName}',
                            style:
                                pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                        pw.Text(
                            'Data: ${doc.createdAt.toIso8601String().substring(0, 16).replaceAll("T", " ")}'),
                        if (doc.originTitle != null)
                          pw.Text('Origem: ${doc.originTitle}'),
                        if (doc.originPowerW != null &&
                            doc.originVoltage != null)
                          pw.Text(
                              'Potência: ${doc.originPowerW!.toStringAsFixed(0)} W — Tensão: ${doc.originVoltage} V'),
                      ],
                    ),
                  ),
                  pw.SizedBox(height: 14),
                  pw.Text('Materiais',
                      style: pw.TextStyle(
                          fontSize: 13, fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 6),
                  pw.Table.fromTextArray(
                    headers: ['Item', 'Qtd', 'Un', 'R\$ Unit', 'R\$ Total'],
                    headerStyle: pw.TextStyle(fontWeight: pw.FontWeight.bold),
                    data: doc.materials
                        .map((m) => [
                              m.name,
                              m.qty.toStringAsFixed(2),
                              m.unit,
                              m.unitPrice.toStringAsFixed(2),
                              m.total.toStringAsFixed(2),
                            ])
                        .toList(),
                    cellStyle: const pw.TextStyle(fontSize: 10),
                    headerDecoration:
                        const pw.BoxDecoration(color: PdfColors.grey200),
                    cellAlignment: pw.Alignment.centerLeft,
                  ),
                  pw.SizedBox(height: 12),
                  pw.Text('Serviços',
                      style: pw.TextStyle(
                          fontSize: 13, fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 6),
                  pw.Table.fromTextArray(
                    headers: ['Serviço', 'R\$'],
                    headerStyle: pw.TextStyle(fontWeight: pw.FontWeight.bold),
                    data: doc.services
                        .map((s) => [s.name, s.price.toStringAsFixed(2)])
                        .toList(),
                    cellStyle: const pw.TextStyle(fontSize: 10),
                    headerDecoration:
                        const pw.BoxDecoration(color: PdfColors.grey200),
                  ),
                  pw.SizedBox(height: 14),
                  pw.Divider(),
                  pw.Row(
                    mainAxisAlignment: pw.MainAxisAlignment.end,
                    children: [
                      pw.Column(
                        crossAxisAlignment: pw.CrossAxisAlignment.end,
                        children: [
                          pw.Text(
                              'Subtotal: R\$ ${doc.subtotal.toStringAsFixed(2)}'),
                          pw.Text(
                              'Margem: R\$ ${doc.marginAmount.toStringAsFixed(2)}'),
                          pw.Text('TOTAL: R\$ ${doc.total.toStringAsFixed(2)}',
                              style: pw.TextStyle(
                                  fontSize: 14,
                                  fontWeight: pw.FontWeight.bold)),
                        ],
                      ),
                    ],
                  ),
                  pw.SizedBox(height: 18),
                  pw.Text('Assinatura do cliente',
                      style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 8),
                  pw.Container(
                    height: 80,
                    decoration: pw.BoxDecoration(
                      border: pw.Border.all(color: PdfColors.grey300),
                      borderRadius: pw.BorderRadius.circular(10),
                    ),
                    child: signature == null
                        ? pw.Center(
                            child: pw.Text('Sem assinatura',
                                style: const pw.TextStyle(
                                    color: PdfColors.grey700)))
                        : pw.Padding(
                            padding: const pw.EdgeInsets.all(8),
                            child: pw.Image(signature, fit: pw.BoxFit.contain),
                          ),
                  ),
                ],
              ),

              // Marca d'água no FREE
              if (!hasPro)
                pw.Positioned(
                  bottom: 20,
                  right: 20,
                  child: pw.Opacity(
                    opacity: 0.25,
                    child: pw.Text(
                      'App FG Elétrica — em breve na Play Store',
                      style: pw.TextStyle(
                          fontSize: 12, fontWeight: pw.FontWeight.bold),
                    ),
                  ),
                ),
            ],
          );
        },
      ),
    );

    final dir = await getTemporaryDirectory();
    final file = File('${dir.path}/orcamento_${doc.id}.pdf');
    await file.writeAsBytes(await pdf.save());
    return file;
  }
}
