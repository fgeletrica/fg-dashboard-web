import 'dart:convert';
import 'dart:io';
import 'package:flutter/services.dart';
import 'package:path_provider/path_provider.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;

import '../models/budget_models.dart';
import 'pro_access.dart';
import 'profile_store.dart';

class PdfService {
  static Future<File> generateBudgetPdf({required BudgetDoc doc}) async {
    // üî¥ ASSINATURA OBRIGAT√ìRIA
    if (doc.signatureB64 == null || doc.signatureB64!.trim().isEmpty) {
      throw Exception('ASSINATURA_OBRIGATORIA');
    }

    final pdf = pw.Document();
    final profile = await ProfileStore.get();
    final hasPro = await ProAccess.hasProAccessNow();

    pw.ImageProvider? logo;
    try {
      final data = await rootBundle.load('assets/logo.png');
      logo = pw.MemoryImage(data.buffer.asUint8List());
    } catch (_) {}

    pw.ImageProvider? signature;
    try {
      final bytes = base64Decode(doc.signatureB64!);
      signature = pw.MemoryImage(bytes);
    } catch (_) {}

    pdf.addPage(
      pw.Page(
        pageFormat: PdfPageFormat.a4,
        margin: const pw.EdgeInsets.all(28),
        build: (ctx) {
          return pw.Stack(
            children: [
              pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  // HEADER
                  pw.Row(
                    crossAxisAlignment: pw.CrossAxisAlignment.center,
                    children: [
                      if (logo != null)
                        pw.Container(width: 44, height: 44, child: pw.Image(logo))
                      else
                        pw.Container(
                          width: 44,
                          height: 44,
                          alignment: pw.Alignment.center,
                          decoration: pw.BoxDecoration(
                            border: pw.Border.all(color: PdfColors.amber),
                            borderRadius: pw.BorderRadius.circular(8),
                          ),
                          child: pw.Text('FG',
                              style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                        ),
                      pw.SizedBox(width: 12),
                      pw.Column(
                        crossAxisAlignment: pw.CrossAxisAlignment.start,
                        children: [
                          pw.Text('FG El√©trica ‚Äî Or√ßamento',
                              style: pw.TextStyle(
                                  fontSize: 18,
                                  fontWeight: pw.FontWeight.bold)),
                          pw.Text('Respons√°vel: ${profile.name}',
                              style: const pw.TextStyle(fontSize: 11)),
                          if (profile.company.isNotEmpty)
                            pw.Text('Empresa: ${profile.company}',
                                style: const pw.TextStyle(fontSize: 11)),
                          if (profile.phone.isNotEmpty)
                            pw.Text('Telefone: ${profile.phone}',
                                style: const pw.TextStyle(fontSize: 11)),
                          if (profile.email.isNotEmpty)
                            pw.Text('E-mail: ${profile.email}',
                                style: const pw.TextStyle(fontSize: 11)),
                        ],
                      ),
                    ],
                  ),

                  pw.SizedBox(height: 14),

                  // DADOS DO CLIENTE
                  pw.Container(
                    padding: const pw.EdgeInsets.all(10),
                    decoration: pw.BoxDecoration(
                      border: pw.Border.all(color: PdfColors.grey300),
                      borderRadius: pw.BorderRadius.circular(10),
                    ),
                    child: pw.Column(
                      crossAxisAlignment: pw.CrossAxisAlignment.start,
                      children: [
                        pw.Text(
                          'Cliente: ${doc.clientName.isEmpty ? "‚Äî" : doc.clientName}',
                          style: pw.TextStyle(fontWeight: pw.FontWeight.bold),
                        ),
                        pw.Text(
                          'Data: ${doc.createdAt.toIso8601String().substring(0, 16).replaceAll("T", " ")}',
                        ),
                        if (doc.originTitle != null)
                          pw.Text('Origem do c√°lculo: ${doc.originTitle}'),
                        if (doc.originPowerW != null && doc.originVoltage != null)
                          pw.Text(
                            'Pot√™ncia: ${doc.originPowerW!.toStringAsFixed(0)} W ‚Äî '
                            'Tens√£o: ${doc.originVoltage} V',
                          ),
                      ],
                    ),
                  ),

                  pw.SizedBox(height: 14),

                  // MATERIAIS
                  pw.Text('Materiais',
                      style: pw.TextStyle(
                          fontSize: 13, fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 6),
                  pw.Table.fromTextArray(
                    headers: ['Item', 'Qtd', 'Un', 'R$ Unit', 'R$ Total'],
                    headerStyle: pw.TextStyle(fontWeight: pw.FontWeight.bold),
                    data: doc.materials
                        .map((m) => [
                              m.name,
                              m.qty.toStringAsFixed(2),
                              m.unit,
                              m.unitPrice.toStringAsFixed(2),
                              m.total.toStringAsFixed(2),
                            ])
                        .toList(),
                    cellStyle: const pw.TextStyle(fontSize: 10),
                    headerDecoration:
                        const pw.BoxDecoration(color: PdfColors.grey200),
                  ),

                  pw.SizedBox(height: 12),

                  // SERVI√áOS
                  pw.Text('Servi√ßos',
                      style: pw.TextStyle(
                          fontSize: 13, fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 6),
                  pw.Table.fromTextArray(
                    headers: ['Servi√ßo', 'Valor (R$)'],
                    headerStyle: pw.TextStyle(fontWeight: pw.FontWeight.bold),
                    data: doc.services
                        .map((s) => [s.name, s.price.toStringAsFixed(2)])
                        .toList(),
                    cellStyle: const pw.TextStyle(fontSize: 10),
                    headerDecoration:
                        const pw.BoxDecoration(color: PdfColors.grey200),
                  ),

                  pw.SizedBox(height: 14),
                  pw.Divider(),

                  // TOTAL
                  pw.Row(
                    mainAxisAlignment: pw.MainAxisAlignment.end,
                    children: [
                      pw.Column(
                        crossAxisAlignment: pw.CrossAxisAlignment.end,
                        children: [
                          pw.Text('Subtotal: R\$ ${doc.subtotal.toStringAsFixed(2)}'),
                          pw.Text('Margem: R\$ ${doc.marginAmount.toStringAsFixed(2)}'),
                          pw.Text(
                            'TOTAL: R\$ ${doc.total.toStringAsFixed(2)}',
                            style: pw.TextStyle(
                                fontSize: 14,
                                fontWeight: pw.FontWeight.bold),
                          ),
                        ],
                      ),
                    ],
                  ),

                  pw.SizedBox(height: 18),

                  // ASSINATURA
                  pw.Text('Assinatura do cliente',
                      style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 8),
                  pw.Container(
                    height: 90,
                    decoration: pw.BoxDecoration(
                      border: pw.Border.all(color: PdfColors.grey400),
                      borderRadius: pw.BorderRadius.circular(10),
                    ),
                    child: pw.Padding(
                      padding: const pw.EdgeInsets.all(8),
                      child: pw.Image(signature!, fit: pw.BoxFit.contain),
                    ),
                  ),

                  pw.SizedBox(height: 20),
                  pw.Divider(),
                  pw.Text(
                    'Documento gerado pelo app FG El√©trica ‚Ä¢ ${DateTime.now().toString().substring(0, 16)}',
                    style: const pw.TextStyle(fontSize: 9, color: PdfColors.grey700),
                  ),
                ],
              ),

              // üî¥ MARCA D‚Äô√ÅGUA NO FREE
              if (!hasPro)
                pw.Center(
                  child: pw.Transform.rotate(
                    angle: -0.5,
                    child: pw.Opacity(
                      opacity: 0.18,
                      child: pw.Text(
                        'FG EL√âTRICA ‚Äî VERS√ÉO GRATUITA',
                        style: pw.TextStyle(
                          fontSize: 42,
                          fontWeight: pw.FontWeight.bold,
                          color: PdfColors.grey600,
                        ),
                      ),
                    ),
                  ),
                ),
            ],
          );
        },
      ),
    );

    final dir = await getTemporaryDirectory();
    final file = File('${dir.path}/orcamento_${doc.id}.pdf');
    await file.writeAsBytes(await pdf.save());
    return file;
  }
}
