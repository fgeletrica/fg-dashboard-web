import "dart:math";
import "package:flutter/material.dart";
import "package:url_launcher/url_launcher.dart";

import "../config/supabase_config.dart";
import "../services/market/market_backend.dart";
import "../services/market/local_market_backend.dart";
import "../services/market/supabase_market_backend.dart";

import "../models/service_request.dart";
import "../services/local_store.dart";
import "../services/subscription_access.dart";

class ServicesMarketScreen extends StatefulWidget {
  const ServicesMarketScreen({super.key});

  @override
  State<ServicesMarketScreen> createState() => _ServicesMarketScreenState();
}

class _ServicesMarketScreenState extends State<ServicesMarketScreen> {
  late final MarketBackend _backend =
      (SupabaseConfig.url.contains('COLE_SUA_SUPABASE_URL_AQUI'))
          ? LocalMarketBackend()
          : SupabaseMarketBackend();

  String _role = "client"; // client | pro
  bool _loading = true;
  String? _err;

  final _qCtrl = TextEditingController();
  bool _showDone = false;

  List<ServiceRequest> _items = [];

  @override
  void initState() {
    super.initState();
    _reload();
    _qCtrl.addListener(() => setState(() {}));
  }

  @override
  void dispose() {
    _qCtrl.dispose();
    super.dispose();
  }

    Future<void> _reload() async {
    setState(() {
      _loading = true;
      _err = null;
    });

    try {
      // timeout pra não ficar infinito
      final role = await LocalStore.getMarketRole().timeout(const Duration(seconds: 6));
      final items = await ServiceRequestsStore.load().timeout(const Duration(seconds: 6));

      if (!mounted) return;
      setState(() {
        _role = role;
        _items = items;
        _loading = false;
      });
    } catch (e) {
      // Se der erro, a gente para o loading e mostra na tela
      if (!mounted) return;
      setState(() {
        _loading = false;
        _err = e.toString();
      });
      // também loga no console
      // ignore: avoid_print
      print("SERVICES_TAB_ERROR: $e");
    }
  });
  }

  Future<void> _setRole(String role) async {
    await LocalStore.setMarketRole(role);
    await _reload();
  }

  String _onlyDigits(String s) => s.replaceAll(RegExp(r"\D+"), "");

  Future<void> _openWhatsApp({required String phone, required String text}) async {
    final p = _onlyDigits(phone);
    if (p.isEmpty) return;
    final url = Uri.parse("https://wa.me/$p?text=${Uri.encodeComponent(text)}");
    await launchUrl(url, mode: LaunchMode.externalApplication);
  }

  bool _isNew(ServiceRequest doc) {
    final diff = DateTime.now().difference(doc.createdAt);
    return diff.inHours <= 24; // NOVO até 24h
  }

  Future<void> _newRequest() async {
    final tCtrl = TextEditingController();
    final dCtrl = TextEditingController();
    final cCtrl = TextEditingController();
    final nCtrl = TextEditingController();
    final pCtrl = TextEditingController();

    final ok = await showDialog<bool>(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text("Novo pedido de serviço"),
        content: SingleChildScrollView(
          child: Column(
            children: [
              TextField(
                controller: tCtrl,
                decoration: const InputDecoration(
                  labelText: "Título (ex: trocar disjuntor)",
                ),
              ),
              const SizedBox(height: 8),
              TextField(
                controller: dCtrl,
                decoration: const InputDecoration(
                  labelText: "Descrição (detalhes do problema)",
                ),
                minLines: 3,
                maxLines: 5,
              ),
              const SizedBox(height: 8),
              TextField(
                controller: cCtrl,
                decoration: const InputDecoration(labelText: "Cidade/Bairro"),
              ),
              const SizedBox(height: 8),
              TextField(
                controller: nCtrl,
                decoration: const InputDecoration(labelText: "Seu nome"),
              ),
              const SizedBox(height: 8),
              TextField(
                controller: pCtrl,
                decoration: const InputDecoration(labelText: "WhatsApp (com DDD)"),
                keyboardType: TextInputType.phone,
              ),
              const SizedBox(height: 6),
              const Text(
                "⚠️ Dica: não poste endereço completo.\nColoque só bairro/cidade.",
                style: TextStyle(fontSize: 12, height: 1.2),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context, false), child: const Text("Cancelar")),
          ElevatedButton(onPressed: () => Navigator.pop(context, true), child: const Text("Publicar")),
        ],
      ),
    );

    if (ok != true) return;

    final doc = ServiceRequest(
      id: "${DateTime.now().millisecondsSinceEpoch}_${Random().nextInt(9999)}",
      createdAt: DateTime.now(),
      title: tCtrl.text.trim(),
      description: dCtrl.text.trim(),
      city: cCtrl.text.trim(),
      contactName: nCtrl.text.trim(),
      contactPhone: pCtrl.text.trim(),
      done: false,
    );

    await _backend.upsert(doc);
    await _reload();
  }

  Future<void> _markDone(ServiceRequest doc, bool done) async {
    doc.done = done;
    await _backend.upsert(doc);
    await _reload();
  }

  List<ServiceRequest> _filtered(List<ServiceRequest> base) {
    final q = _qCtrl.text.trim().toLowerCase();
    if (q.isEmpty) return base;
    return base.where((e) {
      final s = "${e.title} ${e.description} ${e.city} ${e.contactName}".toLowerCase();
      return s.contains(q);
    }).toList();
  }

  Widget _pill(String text, {required bool on, required VoidCallback tap}) {
    return InkWell(
      onTap: tap,
      borderRadius: BorderRadius.circular(999),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(999),
          color: on ? Colors.amber.withOpacity(.18) : Colors.white.withOpacity(.06),
          border: Border.all(color: on ? Colors.amber.withOpacity(.35) : Colors.white.withOpacity(.10)),
        ),
        child: Text(
          text,
          style: TextStyle(
            fontWeight: FontWeight.w800,
            color: on ? Colors.amber : Colors.white.withOpacity(.85),
          ),
        ),
      ),
    );
  }

  Widget _empty(String title, String body) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(18),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.work_outline, size: 54),
            const SizedBox(height: 10),
            Text(title, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w900)),
            const SizedBox(height: 8),
            Text(body, textAlign: TextAlign.center, style: TextStyle(color: Colors.white.withOpacity(.80))),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    if (_loading) return const Center(child: CircularProgressIndicator());

    final openItems = _items.where((e) => !e.done).toList();
    final doneItems = _items.where((e) => e.done).toList();

    final list = _showDone ? doneItems : openItems;
    final visible = _filtered(list);

    return Padding(
      padding: const EdgeInsets.all(14),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // topo: role
          Row(
            children: [
              Expanded(
                child: SegmentedButton<String>(
                  segments: const [
                    ButtonSegment(value: "client", label: Text("Sou Cliente")),
                    ButtonSegment(value: "pro", label: Text("Sou Profissional")),
                  ],
                  selected: {_role},
                  onSelectionChanged: (s) => _setRole(s.first),
                ),
              ),
              const SizedBox(width: 10),
              if (_role == "client")
                ElevatedButton.icon(
                  onPressed: _newRequest,
                  icon: const Icon(Icons.add),
                  label: const Text("Novo"),
                ),
            ],
          ),
          const SizedBox(height: 12),

          // filtro + pills
          TextField(
            controller: _qCtrl,
            decoration: InputDecoration(
              prefixIcon: const Icon(Icons.search),
              hintText: "Buscar pedido (título, cidade, etc)",
              filled: true,
              fillColor: Colors.white.withOpacity(.06),
              border: OutlineInputBorder(borderRadius: BorderRadius.circular(14)),
            ),
          ),
          const SizedBox(height: 10),
          Row(
            children: [
              _pill("Abertos (${openItems.length})", on: !_showDone, tap: () => setState(() => _showDone = false)),
              const SizedBox(width: 8),
              _pill("Concluídos (${doneItems.length})", on: _showDone, tap: () => setState(() => _showDone = true)),
              const Spacer(),
              if (_role == "pro")
                FutureBuilder<bool>(
                  future: SubscriptionAccess.hasPro(),
                  builder: (_, snap) {
                    final hasPro = snap.data ?? false;
                    return Text(
                      hasPro ? "PRO ✅" : "FREE",
                      style: TextStyle(
                        fontWeight: FontWeight.w900,
                        color: hasPro ? Colors.amber : Colors.white.withOpacity(.65),
                      ),
                    );
                  },
                ),
            ],
          ),
          const SizedBox(height: 10),

          if (_role == "pro") ...[
            Text(
              "Pedidos abertos (MVP offline)",
              style: const TextStyle(fontWeight: FontWeight.w900),
            ),
            const SizedBox(height: 4),
            Text(
              "Depois a gente liga online por região (Supabase) e ranking.",
              style: TextStyle(fontSize: 12, color: Colors.white.withOpacity(.75)),
            ),
            const SizedBox(height: 8),
          ] else ...[
            const Text("Meus pedidos", style: TextStyle(fontWeight: FontWeight.w900)),
            const SizedBox(height: 8),
          ],

          Expanded(
            child: visible.isEmpty
                ? (_role == "client"
                    ? _empty(
                        "Nada por aqui ainda",
                        _showDone
                            ? "Quando você marcar um pedido como concluído, ele aparece aqui."
                            : "Crie seu primeiro pedido no botão “Novo”.",
                      )
                    : _empty(
                        "Nenhum pedido encontrado",
                        _showDone
                            ? "Os concluídos aparecem aqui."
                            : "Quando tiver pedidos, eles vão aparecer aqui.",
                      ))
                : ListView(
                    children: visible.map((e) {
                      final title = e.title.isEmpty ? "(sem título)" : e.title;
                      final city = e.city.isEmpty ? "—" : e.city;
                      final who = e.contactName.isEmpty ? "Cliente" : e.contactName;

                      final badgeNew = _isNew(e) && !e.done;

                      return Card(
                        child: ListTile(
                          title: Row(
                            children: [
                              Expanded(child: Text(title)),
                              if (badgeNew)
                                Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 3),
                                  decoration: BoxDecoration(
                                    color: Colors.green.withOpacity(.18),
                                    borderRadius: BorderRadius.circular(999),
                                    border: Border.all(color: Colors.green.withOpacity(.35)),
                                  ),
                                  child: const Text("NOVO", style: TextStyle(fontWeight: FontWeight.w900, fontSize: 12)),
                                ),
                            ],
                          ),
                          subtitle: Text(
                            _role == "pro"
                                ? "$city • $who\n${e.description}".trim()
                                : "${e.city}\n${e.description}".trim(),
                          ),
                          isThreeLine: true,
                          trailing: _role == "client"
                              ? IconButton(
                                  icon: Icon(e.done ? Icons.undo : Icons.check_circle_outline),
                                  onPressed: () => _markDone(e, !e.done),
                                  tooltip: e.done ? "Voltar para aberto" : "Marcar como concluído",
                                )
                              : IconButton(
                                  icon: const Icon(Icons.chat),
                                  onPressed: () => _openWhatsApp(
                                    phone: e.contactPhone,
                                    text: "Olá! Vi seu pedido no app FG Elétrica: \"$title\". Podemos conversar?",
                                  ),
                                  tooltip: "Chamar no WhatsApp",
                                ),
                        ),
                      );
                    }).toList(),
                  ),
          ),
        ],
      ),
    );
  }
}
