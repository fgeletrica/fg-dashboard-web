import 'package:meu_ajudante_fg/models/budget_models.dart' as bm;
import 'dart:convert';
import 'package:flutter/material.dart';
import '../core/app_theme.dart';
import '../core/eletrico_calc.dart';
import '../core/local_store.dart';
import '../routes/app_routes.dart';
import 'budget_editor_screen.dart';
import 'calc_history_screen.dart';
import '../models/budget_models.dart' as bm;
class CalcScreen extends StatefulWidget {
  const CalcScreen({super.key});

  @override
  State<CalcScreen> createState() => _CalcScreenState();
}

class _CalcScreenState extends State<CalcScreen> {
  bool _modoRapido = true;
  
  bool _showAdvanced = false;
final _potCtrl = TextEditingController();
  final _distCtrl = TextEditingController();
  double _tensao = 220;

  // opcionais
  final _fpCtrl = TextEditingController(text: '1.0');   // fator de potência
  final _etaCtrl = TextEditingController(text: '1.0');  // rendimento
  final _limCtrl = TextEditingController(text: '4.0');  // limite queda (%)

  String _title = 'Cálculo Elétrico';

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    final args = ModalRoute.of(context)?.settings.arguments;
    if (args is Map) {
      final t = (args['title'] ?? '').toString();
      final pw = args['powerW'];
      final v = args['voltage'];
      if (t.isNotEmpty) _title = t;
      if (pw != null) _potCtrl.text = pw.toString();
      if (v != null) _tensao = double.tryParse(v.toString()) ?? _tensao;
    }
  }

  @override
  void dispose() {
    _potCtrl.dispose();
    _distCtrl.dispose();
    _fpCtrl.dispose();
    _etaCtrl.dispose();
    _limCtrl.dispose();
    super.dispose();
  }

  double _d(TextEditingController c, double fallback) =>
      double.tryParse(c.text.trim().replaceAll(',', '.')) ?? fallback;

  Future<void> _calc() async {
    final pot = _d(_potCtrl, 0);
    final dist = _d(_distCtrl, 0);
    final fp = ((_modoRapido || !_showAdvanced) ? 1.0 : (_d(_fpCtrl, 1.0)));
    final eta = ((_modoRapido || !_showAdvanced) ? 1.0 : (_d(_etaCtrl, 1.0)));
    final lim = ((_modoRapido || !_showAdvanced) ? 4.0 : (_d(_limCtrl, 4.0)));

    if (pot <= 0 || dist < 0 || _tensao <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Preencha Potência, Tensão e Distância corretamente.')),
      );
      return;
    }

    final fpOk = fp <= 0 ? 1.0 : fp;
    final etaOk = eta <= 0 ? 1.0 : eta;

    // Potência elétrica efetiva (se usuário colocar FP/η diferentes)
    final potEfetiva = pot / (fpOk * etaOk);

    // Usa seu core/eletrico_calc.dart
    final res = EletricoCalc.dimensionar(
      potW: potEfetiva,
      tensaoV: _tensao,
      distanciaM: dist,
      limiteQvPct: lim,
    );

    final ib = res.ibA;
    final cabo = res.caboMm2;
    final disj = res.disjuntorA;
    final qv = res.quedaTensaoPct;
    final iz = res.izA;

    // salva no histórico (top 20)
    try {
      await LocalStore.addCalcHistoryRaw(jsonEncode({
        'title': _title,
        'potW': pot.toStringAsFixed(0),
        'tensaoV': _tensao.toStringAsFixed(0),
        'distM': dist.toStringAsFixed(0),
        'ibA': ib.toStringAsFixed(2),
        'caboMm2': cabo.toStringAsFixed(1),
        'disjA': disj.toStringAsFixed(0),
        'izA': iz.toString(),
        'qvPct': qv.toStringAsFixed(2),
        'ts': DateTime.now().millisecondsSinceEpoch,
      }));
    } catch (_) {}

    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text('Resultado — $_title'),
        content: SingleChildScrollView(
          child: Text(
            'Entradas:\n'
            '• Potência: ${pot.toStringAsFixed(0)} W\n'
            '• Tensão: ${_tensao.toStringAsFixed(0)} V\n'
            '• Distância: ${dist.toStringAsFixed(0)} m\n'
            '• FP (opcional): ${fpOk.toStringAsFixed(2)}\n'
            '• Rendimento η (opcional): ${etaOk.toStringAsFixed(2)}\n'
            '• Limite queda: ${lim.toStringAsFixed(1)} %\n\n'
            'Cálculo técnico:\n'
            '• Corrente (Ib): ${ib.toStringAsFixed(2)} A\n'
            '• Cabo sugerido: ${cabo.toStringAsFixed(1)} mm²\n'
            '• Capacidade (Iz): ${iz} A\n'
            '• Disjuntor: ${disj} A\n'
            '• Queda de tensão: ${qv.toStringAsFixed(2)} %\n\n'
            'Notas:\n'
            '• Regra: In ≥ Ib e In ≤ Iz do cabo.\n'
            '• Se a queda estourar, o app sobe a seção.\n'
            '• Para motores/ar-condicionado, FP e η podem mudar o Ib.\n',
          ),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context), child: const Text('Fechar')),
          FilledButton(
            onPressed: () {
              Navigator.pop(context);

              final doc = bm.BudgetDoc.newDoc(
                originTitle: _title,
                originPowerW: pot,
                originVoltage: _tensao.toInt(),
                originDistanceM: dist,
              );

              // Pré-preenchimentos úteis (simples pro dia a dia)
              // Cabo (ida+volta estimado)
              final double metros = (dist <= 0) ? 0.0 : (dist * 2.0);
              if (metros > 0) {
                doc.materials.add(bm.BudgetItem(
                  name: 'Cabo ${cabo.toStringAsFixed(1)} mm²',
                  qty: metros,
                  unit: 'm',
                  unitPrice: 0,
                ));
              }
              doc.materials.add(bm.BudgetItem(
                name: 'Disjuntor ${disj.toStringAsFixed(0)}A',
                qty: 1,
                unit: 'un',
                unitPrice: 0,
              ));

              doc.services.add(bm.BudgetServiceLine(
                name: 'Mão de obra',
                price: 0,
              ));

              Navigator.of(context).push(
                MaterialPageRoute(builder: (_) => BudgetEditorScreen(doc: doc)),
              );
            },
            child: const Text('Criar orçamento'),
          ),
        ],
      ),
    );
  }

  InputDecoration _dec(String label) => InputDecoration(
        labelText: label,
        labelStyle: TextStyle(color: Colors.white.withOpacity(.75), fontWeight: FontWeight.w700),
        filled: true,
        fillColor: AppTheme.card,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide(color: Colors.white.withOpacity(.12))),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide(color: Colors.white.withOpacity(.12))),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide(color: AppTheme.gold.withOpacity(.65))),
      );

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppTheme.bg,
      appBar: AppBar(
        backgroundColor: AppTheme.bg,
        elevation: 0,
        title: Text(_title),
        actions: const [],
      ),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: ListView(
          children: [
            const SizedBox(height: 6),
            SwitchListTile(
              contentPadding: EdgeInsets.zero,
              title: const Text('Modo rapido'),
              subtitle: const Text('Calculo automatico para uso em obra'),
              value: _modoRapido,
              onChanged: (v) => setState(() { _modoRapido = v; if (v) _showAdvanced = false; }),
            ),
            const Divider(height: 18),

            Text(
              _title,
              style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18),
            ),
            const SizedBox(height: 12),

            if (!_modoRapido && _showAdvanced) ...[
            TextField(
              controller: _potCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Potencia (W)'),
            ),
            const SizedBox(height: 12),

            DropdownButtonFormField<double>(
              value: _tensao,
              decoration: _dec('Tensao (V)'),
              items: const [
                DropdownMenuItem(value: 127, child: Text('127 V')),
                DropdownMenuItem(value: 220, child: Text('220 V')),
              ],
              onChanged: (v) => setState(() => _tensao = v ?? 220),
            ),
            const SizedBox(height: 12),

            TextField(
              controller: _distCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Distancia (m)'),
            ),
            const SizedBox(height: 12),

            TextField(
              controller: _fpCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Fator de potencia (FP)'),
            ],
            ),
            const SizedBox(height: 12),

            TextField(
              controller: _etaCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Rendimento'),
            ),
            const SizedBox(height: 12),

            TextField(
              controller: _limCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Limite de queda (%)'),
            ),

            const SizedBox(height: 16),
            SizedBox(
              height: 52,
              child: ElevatedButton.icon(
                onPressed: _calc,
                icon: const Icon(Icons.calculate),
                label: const Text('Calcular', style: TextStyle(fontWeight: FontWeight.w900)),
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppTheme.gold,
                  foregroundColor: Colors.black,
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
// DISJUNTOR_START
int pickBreaker(double ib) {
  const values = [6, 10, 16, 20, 25, 32, 40, 50, 63];
  for (final v in values) {
    if (v >= ib) return v;
  }
  return values.last;
}
// DISJUNTOR_END
// AVISO_DISJUNTOR_START
String breakerHint(double ib, int disj) {
  if (disj > ib * 1.4) {
    return 'Obs.: valor segue padrão comercial e norma técnica.';
  }
  return '';
}
// AVISO_DISJUNTOR_END
// BTN_ORC_START
Widget btnOrcamento(VoidCallback onTap) {
  return SizedBox(
    width: double.infinity,
    height: 52,
    child: ElevatedButton(
      onPressed: onTap,
      child: const Text('Usar no orçamento'),
    ),
  );
}
// BTN_ORC_END
