import 'dart:io';
import 'package:flutter/material.dart';
import 'package:share_plus/share_plus.dart';
import 'package:open_filex/open_filex.dart';

import '../models/budget_models.dart';
import '../services/budget_store.dart';
import '../services/pdf_service.dart';
import '../services/pro_access.dart';
import 'signature_screen.dart';

class BudgetEditorScreen extends StatefulWidget {
  final BudgetDoc doc;
  const BudgetEditorScreen({super.key, required this.doc});

  @override
  State<BudgetEditorScreen> createState() => _BudgetEditorScreenState();
}

class _BudgetEditorScreenState extends State<BudgetEditorScreen> {
  late BudgetDoc doc;

  final clientCtrl = TextEditingController();
  final marginCtrl = TextEditingController();

  @override
  void initState() {
    super.initState();
    doc = widget.doc;
    clientCtrl.text = doc.clientName;
    marginCtrl.text = doc.marginValue.toStringAsFixed(2);
  }

  @override
  void dispose() {
    clientCtrl.dispose();
    marginCtrl.dispose();
    super.dispose();
  }

  double toDouble(String s) =>
      double.tryParse(s.replaceAll(',', '.').trim()) ?? 0.0;
  String money(double v) => "R\$ ${v.toStringAsFixed(2)}";

  InputDecoration dec(String label) => InputDecoration(
        labelText: label,
        filled: true,
        fillColor: const Color(0xFF141A22),
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(14)),
      );

  void addMaterial() => setState(() => doc.materials.add(
      BudgetItem(name: "Novo material", qty: 1, unit: "un", unitPrice: 0)));
  void addService() => setState(() =>
      doc.services.add(BudgetServiceLine(name: "Novo serviço", price: 0)));

  Future<void> save() async {
    doc.clientName = clientCtrl.text.trim();
    doc.marginValue = toDouble(marginCtrl.text);

    await BudgetStore.upsert(doc);
    if (!mounted) return;
    ScaffoldMessenger.of(context)
        .showSnackBar(const SnackBar(content: Text("Orçamento salvo ✅")));
    setState(() {});
  }

  Future<void> sign() async {
    final b64 = await Navigator.push<String?>(
      context,
      MaterialPageRoute(builder: (_) => const SignatureScreen()),
    );
    if (b64 == null) return;
    setState(() => doc.signatureB64 = b64);
    await save();
  }

  Future<void> exportPdf({required bool share}) async {
    try {
      final file = await PdfService.generateBudgetPdf(doc: doc);
      if (!mounted) return;

      if (share) {
        await Share.shareXFiles([XFile(file.path)], text: "Orçamento FG Elétrica");
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text("Abrindo PDF...")),
        );
        await OpenFilex.open(file.path);
      }
    } catch (e) {
      final msg = e.toString();

      // Assinatura obrigatória (PdfService)
      if (msg.contains('ASSINATURA_OBRIGATORIA')) {
        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text("Assinatura obrigatória — peça o cliente para assinar.")),
        );
        await sign(); // abre assinatura e salva
        // tenta de novo depois de assinar
        if (!mounted) return;
        try {
          final file = await PdfService.generateBudgetPdf(doc: doc);
          if (!mounted) return;

          if (share) {
            await Share.shareXFiles([XFile(file.path)], text: "Orçamento FG Elétrica");
          } else {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(content: Text("Abrindo PDF...")),
            );
            await OpenFilex.open(file.path);
          }
        } catch (e2) {
          if (!mounted) return;
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text("Não consegui gerar o PDF: $e2")),
          );
        }
        return;
      }

      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Erro ao gerar PDF: $e")),
      );
    }
  }
  }

  Future<void> applyMaterialPricesFromDb() async {
    final db = await BudgetStore.loadMaterialsDb();
    if (db.isEmpty) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text("Cadastre materiais primeiro.")));
      return;
    }

    int hits = 0;
    for (final it in doc.materials) {
      final name = it.name.toLowerCase().trim();
      if (name.isEmpty) continue;

      Map<String, dynamic>? best;
      for (final m in db) {
        final mn = (m["name"] ?? "").toString().toLowerCase().trim();
        if (mn.isEmpty) continue;
        if (name.contains(mn) || mn.contains(name)) {
          best = m;
          break;
        }
      }
      if (best != null) {
        it.unit = (best["unit"] ?? it.unit).toString();
        it.unitPrice = (best["price"] ?? it.unitPrice).toDouble();
        hits++;
      }
    }

    if (!mounted) return;
    setState(() {});
    ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Preços aplicados em $hits item(ns).")));
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text("Editar Orçamento"),
        actions: [
          IconButton(
            tooltip: "Aplicar preços",
            onPressed: applyMaterialPricesFromDb,
            icon: const Icon(Icons.auto_fix_high),
          ),
          IconButton(
            tooltip: "Assinatura",
            onPressed: sign,
            icon: const Icon(Icons.edit),
          ),
          IconButton(
            tooltip: "PDF",
            onPressed: () => exportPdf(share: false),
            icon: const Icon(Icons.picture_as_pdf),
          ),
          IconButton(
            tooltip: "WhatsApp",
            onPressed: () => exportPdf(share: true),
            icon: const Icon(Icons.share),
          ),
          TextButton(
            onPressed: save,
            child: const Text("SALVAR",
                style: TextStyle(fontWeight: FontWeight.w900)),
          ),
        ],
      ),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          if (doc.originTitle != null)
            _card(
              child: Text(
                "Origem: ${doc.originTitle} • ${doc.originPowerW?.toStringAsFixed(0) ?? '—'}W • ${doc.originVoltage ?? '—'}V",
                style: const TextStyle(color: Colors.white70),
              ),
            ),
          TextField(controller: clientCtrl, decoration: dec("Cliente")),
          const SizedBox(height: 12),
          Row(
            children: [
              const Expanded(
                  child: Text("Materiais",
                      style: TextStyle(
                          fontWeight: FontWeight.w900, fontSize: 16))),
              TextButton(
                  onPressed: addMaterial, child: const Text("+ Adicionar")),
            ],
          ),
          const SizedBox(height: 8),
          ...doc.materials.asMap().entries.map((e) {
            final i = e.key;
            final it = e.value;
            return _card(
              child: Column(
                children: [
                  _head("Material",
                      onDelete: () =>
                          setState(() => doc.materials.removeAt(i))),
                  TextField(
                    controller: TextEditingController(text: it.name),
                    decoration: dec("Nome"),
                    onChanged: (v) => it.name = v,
                  ),
                  const SizedBox(height: 8),
                  Row(
                    children: [
                      Expanded(
                        child: TextField(
                          controller: TextEditingController(
                              text: it.qty.toStringAsFixed(2)),
                          decoration: dec("Qtd"),
                          keyboardType: const TextInputType.numberWithOptions(
                              decimal: true),
                          onChanged: (v) =>
                              setState(() => it.qty = toDouble(v)),
                        ),
                      ),
                      const SizedBox(width: 10),
                      Expanded(
                        child: TextField(
                          controller: TextEditingController(text: it.unit),
                          decoration: dec("Unidade"),
                          onChanged: (v) => setState(() => it.unit = v),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: TextEditingController(
                        text: it.unitPrice.toStringAsFixed(2)),
                    decoration: dec("Preço unitário (R\$)"),
                    keyboardType:
                        const TextInputType.numberWithOptions(decimal: true),
                    onChanged: (v) =>
                        setState(() => it.unitPrice = toDouble(v)),
                  ),
                  const SizedBox(height: 8),
                  Align(
                    alignment: Alignment.centerRight,
                    child: Text("Total: ${money(it.total)}",
                        style: const TextStyle(fontWeight: FontWeight.w900)),
                  ),
                ],
              ),
            );
          }),
          const SizedBox(height: 10),
          Row(
            children: [
              const Expanded(
                  child: Text("Serviços",
                      style: TextStyle(
                          fontWeight: FontWeight.w900, fontSize: 16))),
              TextButton(
                  onPressed: addService, child: const Text("+ Adicionar")),
            ],
          ),
          const SizedBox(height: 8),
          ...doc.services.asMap().entries.map((e) {
            final i = e.key;
            final s = e.value;
            return _card(
              child: Column(
                children: [
                  _head("Serviço",
                      onDelete: () => setState(() => doc.services.removeAt(i))),
                  TextField(
                    controller: TextEditingController(text: s.name),
                    decoration: dec("Nome"),
                    onChanged: (v) => s.name = v,
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller:
                        TextEditingController(text: s.price.toStringAsFixed(2)),
                    decoration: dec("Preço (R\$)"),
                    keyboardType:
                        const TextInputType.numberWithOptions(decimal: true),
                    onChanged: (v) => setState(() => s.price = toDouble(v)),
                  ),
                ],
              ),
            );
          }),
          const SizedBox(height: 10),
          _card(
            child: Column(
              children: [
                Row(
                  children: [
                    Expanded(
                      child: DropdownButtonFormField<String>(
                        value: doc.marginPercent ? "%" : "R\$",
                        items: const [
                          DropdownMenuItem(
                              value: "%", child: Text("% (porcentagem)")),
                          DropdownMenuItem(
                              value: "R\$", child: Text("R\$ (fixo)")),
                        ],
                        onChanged: (v) =>
                            setState(() => doc.marginPercent = (v == "%")),
                        decoration: dec("Tipo de margem"),
                      ),
                    ),
                    const SizedBox(width: 10),
                    Expanded(
                      child: TextField(
                        controller: marginCtrl,
                        decoration: dec(
                            doc.marginPercent ? "Margem (%)" : "Margem (R\$)"),
                        keyboardType: const TextInputType.numberWithOptions(
                            decimal: true),
                        onChanged: (_) => setState(() {}),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 10),
                _row("Subtotal materiais", money(doc.subtotalMaterials)),
                _row("Subtotal serviços", money(doc.subtotalServices)),
                _row("Margem", money(doc.marginAmount)),
                const Divider(),
                _row("TOTAL", money(doc.total), strong: true),
              ],
            ),
          ),
          const SizedBox(height: 10),
          FutureBuilder<bool>(
            future: ProAccess.hasProAccessNow(),
            builder: (context, snap) {
              final pro = snap.data ?? false;
              return Text(
                pro
                    ? "PRO ativo: PDF sai limpo ✅"
                    : "FREE: PDF sai com marca d'água ✅ (PRO remove)",
                style: const TextStyle(color: Colors.white70),
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _card({required Widget child}) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: const Color(0xFF141A22),
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: const Color(0xFF2B2F3A)),
      ),
      child: child,
    );
  }

  Widget _head(String title, {required VoidCallback onDelete}) {
    return Row(
      children: [
        const Icon(Icons.drag_indicator),
        const SizedBox(width: 8),
        Expanded(
            child: Text(title,
                style: const TextStyle(fontWeight: FontWeight.w900))),
        IconButton(onPressed: onDelete, icon: const Icon(Icons.delete)),
      ],
    );
  }

  Widget _row(String a, String b, {bool strong = false}) {
    final style = TextStyle(
      color: strong ? Colors.white : Colors.white70,
      fontWeight: strong ? FontWeight.w900 : FontWeight.w600,
      fontSize: strong ? 16 : 14,
    );
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        children: [
          Expanded(child: Text(a, style: style)),
          Text(b, style: style),
        ],
      ),
    );
  }
}
