import 'package:flutter/material.dart';
import '../core/app_theme.dart';
import '../core/eletrico_calc.dart';
import '../routes/app_routes.dart';

class CalcScreen extends StatefulWidget {
  const CalcScreen({super.key});

  @override
  State<CalcScreen> createState() => _CalcScreenState();
}

class _CalcScreenState extends State<CalcScreen> {
  final _potCtrl = TextEditingController();
  final _distCtrl = TextEditingController();
  double _tensao = 220;

  // opcionais
  final _fpCtrl = TextEditingController(text: '1.0');   // fator de potência
  final _etaCtrl = TextEditingController(text: '1.0');  // rendimento
  final _limCtrl = TextEditingController(text: '4.0');  // limite queda (%)

  String _title = 'Cálculo Elétrico';

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    final args = ModalRoute.of(context)?.settings.arguments;
    if (args is Map) {
      final t = (args['title'] ?? '').toString();
      final pw = args['powerW'];
      final v = args['voltage'];
      if (t.isNotEmpty) _title = t;
      if (pw != null) _potCtrl.text = pw.toString();
      if (v != null) _tensao = double.tryParse(v.toString()) ?? _tensao;
    }
  }

  @override
  void dispose() {
    _potCtrl.dispose();
    _distCtrl.dispose();
    _fpCtrl.dispose();
    _etaCtrl.dispose();
    _limCtrl.dispose();
    super.dispose();
  }

  double _d(TextEditingController c, double fallback) =>
      double.tryParse(c.text.trim().replaceAll(',', '.')) ?? fallback;

  void _calc() {
    final pot = _d(_potCtrl, 0);
    final dist = _d(_distCtrl, 0);
    final fp = _d(_fpCtrl, 1.0);
    final eta = _d(_etaCtrl, 1.0);
    final lim = _d(_limCtrl, 4.0);

    if (pot <= 0 || dist < 0 || _tensao <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Preencha Potência, Tensão e Distância corretamente.')),
      );
      return;
    }

    final fpOk = fp <= 0 ? 1.0 : fp;
    final etaOk = eta <= 0 ? 1.0 : eta;

    // Potência elétrica efetiva (se usuário colocar FP/η diferentes)
    final potEfetiva = pot / (fpOk * etaOk);

    // Usa seu core/eletrico_calc.dart
    final res = EletricoCalc.dimensionar(
      potW: potEfetiva,
      tensaoV: _tensao,
      distanciaM: dist,
      limiteQvPct: lim,
    );

    final ib = res.ibA;
    final cabo = res.caboMm2;
    final disj = res.disjuntorA;
    final qv = res.quedaTensaoPct;
    final iz = res.izA;

    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text('Resultado — $_title'),
        content: SingleChildScrollView(
          child: Text(
            'Entradas:\n'
            '• Potência: ${pot.toStringAsFixed(0)} W\n'
            '• Tensão: ${_tensao.toStringAsFixed(0)} V\n'
            '• Distância: ${dist.toStringAsFixed(0)} m\n'
            '• FP (opcional): ${fpOk.toStringAsFixed(2)}\n'
            '• Rendimento η (opcional): ${etaOk.toStringAsFixed(2)}\n'
            '• Limite queda: ${lim.toStringAsFixed(1)} %\n\n'
            'Cálculo técnico:\n'
            '• Corrente (Ib): ${ib.toStringAsFixed(2)} A\n'
            '• Cabo sugerido: ${cabo.toStringAsFixed(1)} mm²\n'
            '• Capacidade (Iz): ${iz} A\n'
            '• Disjuntor: ${disj} A\n'
            '• Queda de tensão: ${qv.toStringAsFixed(2)} %\n\n'
            'Notas:\n'
            '• Regra: In ≥ Ib e In ≤ Iz do cabo.\n'
            '• Se a queda estourar, o app sobe a seção.\n'
            '• Para motores/ar-condicionado, FP e η podem mudar o Ib.\n',
          ),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context), child: const Text('Fechar')),
          FilledButton(
            onPressed: () {
              Navigator.pop(context);
              Navigator.of(context).pushNamed(
                AppRoutes.orcamentos,
                arguments: {
                  'from_calc': true,
                  'title': _title,
                  'potW': pot,
                  'tensaoV': _tensao,
                  'distM': dist,
                  'ibA': ib,
                  'caboMm2': cabo,
                  'disjA': disj,
                  'izA': iz,
                  'qvPct': qv,
                },
              );
            },
            child: const Text('Criar orçamento'),
          ),
        ],
      ),
    );
  }

  InputDecoration _dec(String label) => InputDecoration(
        labelText: label,
        labelStyle: TextStyle(color: Colors.white.withOpacity(.75), fontWeight: FontWeight.w700),
        filled: true,
        fillColor: AppTheme.card,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide(color: Colors.white.withOpacity(.12))),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide(color: Colors.white.withOpacity(.12))),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide(color: AppTheme.gold.withOpacity(.65))),
      );

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppTheme.bg,
      appBar: AppBar(
        backgroundColor: AppTheme.bg,
        title: Text('Cálculo Elétrico'),
      ),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: ListView(
          children: [
            Text(_title, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 18)),
            const SizedBox(height: 12),

            TextField(
              controller: _potCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Potência (W) — obrigatório'),
            ),
            const SizedBox(height: 12),

            DropdownButtonFormField<double>(
              value: _tensao,
              items: const [
                DropdownMenuItem(value: 127, child: Text('127 V')),
                DropdownMenuItem(value: 220, child: Text('220 V')),
              ],
              onChanged: (v) => setState(() => _tensao = v ?? 220),
              decoration: _dec('Tensão (V) — obrigatório'),
              dropdownColor: AppTheme.card,
              style: const TextStyle(color: Colors.white),
            ),
            const SizedBox(height: 12),

            TextField(
              controller: _distCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Distância (m) — obrigatório'),
            ),

            const SizedBox(height: 16),
            Text('Opcional (se você souber):', style: TextStyle(color: Colors.white.withOpacity(.85), fontWeight: FontWeight.w800)),
            const SizedBox(height: 10),

            TextField(
              controller: _fpCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Fator de potência (FP) — padrão 1.0'),
            ),
            const SizedBox(height: 12),

            TextField(
              controller: _etaCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Rendimento (η) — padrão 1.0'),
            ),
            const SizedBox(height: 12),

            TextField(
              controller: _limCtrl,
              keyboardType: TextInputType.number,
              decoration: _dec('Limite de queda (%) — padrão 4.0'),
            ),

            const SizedBox(height: 16),
            SizedBox(
              height: 52,
              child: ElevatedButton.icon(
                onPressed: _calc,
                icon: const Icon(Icons.calculate),
                label: const Text('Calcular', style: TextStyle(fontWeight: FontWeight.w900)),
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppTheme.gold,
                  foregroundColor: Colors.black,
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
