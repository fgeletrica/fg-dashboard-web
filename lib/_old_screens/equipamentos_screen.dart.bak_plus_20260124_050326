import 'package:flutter/material.dart';
import '../core/app_theme.dart';
import '../services/pro_access.dart';
import '../routes/app_routes.dart';

class EquipamentosScreen extends StatefulWidget {
  const EquipamentosScreen({super.key});

  @override
  State<EquipamentosScreen> createState() => _EquipamentosScreenState();
}

class _EquipamentosScreenState extends State<EquipamentosScreen> {
  bool _loading = true;
  bool _pro = false;

  @override
  void initState() {
    super.initState();
    _check();
  }

  Future<void> _check() async {
    final ok = await ProAccess.hasProAccessNow();
    if (!mounted) return;
    setState(() {
      _pro = ok;
      _loading = false;
    });
  }

  // BTU/h -> potência elétrica aproximada (W)
  int _btuToW(int btu) => (btu * 0.09).round();

  void _goCalcPrefill({required String title, required int powerW, required int voltage}) {
    Navigator.of(context).pushNamed(
      AppRoutes.calc,
      arguments: {"title": title, "powerW": powerW, "voltage": voltage},
    );
  }

  Future<void> _openPaywall() async {
    await Navigator.of(context).pushNamed(AppRoutes.paywall);
    await _check(); // recarrega status ao voltar
  }

  Future<void> _onTapItem(_EquipItem item) async {
    if (item.proOnly && !_pro) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Recurso PRO — desbloqueie para usar ✅')),
      );
      await _openPaywall();
      return;
    }
    item.onTap();
  }

  @override
  Widget build(BuildContext context) {
    final items = _buildItems();

    return Scaffold(
      backgroundColor: AppTheme.bg,
      appBar: AppBar(
        backgroundColor: AppTheme.bg,
        elevation: 0,
        title: const Text('Equipamentos'),
        actions: [
          Padding(
            padding: const EdgeInsets.only(right: 12),
            child: Center(
              child: Text(
                _loading ? '' : (_pro ? 'PRO' : 'FREE'),
                style: TextStyle(
                  color: _pro ? AppTheme.gold : Colors.white70,
                  fontWeight: FontWeight.w900,
                ),
              ),
            ),
          ),
        ],
      ),
      body: _loading
          ? const Center(child: CircularProgressIndicator())
          : ListView(
              padding: const EdgeInsets.all(16),
              children: [
                _bannerPro(),
                const SizedBox(height: 14),
                ...items,
              ],
            ),
    );
  }

  Widget _bannerPro() {
    return Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: AppTheme.card,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: AppTheme.border.withOpacity(.35)),
      ),
      child: Row(
        children: [
          Icon(_pro ? Icons.verified : Icons.lock_outline, color: _pro ? AppTheme.gold : Colors.white70),
          const SizedBox(width: 10),
          Expanded(
            child: Text(
              _pro
                  ? 'PRO ativo ✅  Todos os equipamentos liberados.'
                  : 'Alguns equipamentos são PRO. Os FREE ficam liberados.',
              style: TextStyle(color: Colors.white.withOpacity(.85), fontWeight: FontWeight.w800),
            ),
          ),
          if (!_pro)
            TextButton(
              onPressed: _openPaywall,
              child: Text('Ver planos', style: TextStyle(color: AppTheme.gold, fontWeight: FontWeight.w900)),
            ),
        ],
      ),
    );
  }

  List<Widget> _buildItems() {
    final list = <Widget>[];

    void section(String t) {
      list.add(const SizedBox(height: 6));
      list.add(Padding(
        padding: const EdgeInsets.only(bottom: 10),
        child: Text(t, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w900)),
      ));
    }

    void tile(_EquipItem item) {
      list.add(_tile(
        title: item.title,
        subtitle: item.subtitle,
        proOnly: item.proOnly,
        onTap: () => _onTapItem(item),
      ));
    }

    // FREE + PRO misturado de verdade
    section('Chuveiros (W)');
    tile(_EquipItem.free(
      'Chuveiro 4500W (127V)',
      'FREE • toque para preencher no cálculo',
      () => _goCalcPrefill(title: 'Chuveiro 4500W', powerW: 4500, voltage: 127),
    ));
    tile(_EquipItem.free(
      'Chuveiro 5500W (220V)',
      'FREE • toque para preencher no cálculo',
      () => _goCalcPrefill(title: 'Chuveiro 5500W', powerW: 5500, voltage: 220),
    ));
    tile(_EquipItem.pro(
      'Chuveiro 6800W (220V)',
      'PRO • toque para preencher no cálculo',
      () => _goCalcPrefill(title: 'Chuveiro 6800W', powerW: 6800, voltage: 220),
    ));
    tile(_EquipItem.pro(
      'Chuveiro 7500W (220V)',
      'PRO • toque para preencher no cálculo',
      () => _goCalcPrefill(title: 'Chuveiro 7500W', powerW: 7500, voltage: 220),
    ));

    section('Ar condicionado (BTU → W)');
    for (final btu in [7500, 9000, 10000]) {
      final w = _btuToW(btu);
      tile(_EquipItem.free(
        'Ar de janela $btu BTU (≈ ${w}W)',
        'FREE • toque para preencher no cálculo',
        () => _goCalcPrefill(title: 'Ar $btu BTU', powerW: w, voltage: 220),
      ));
    }
    for (final btu in [12000, 18000]) {
      final w = _btuToW(btu);
      tile(_EquipItem.pro(
        'Ar de janela $btu BTU (≈ ${w}W)',
        'PRO • toque para preencher no cálculo',
        () => _goCalcPrefill(title: 'Ar $btu BTU', powerW: w, voltage: 220),
      ));
    }

    list.add(const SizedBox(height: 10));
    list.add(Text(
      'Obs.: BTU→W é aproximação. Você pode ajustar manualmente na tela de cálculo.',
      style: TextStyle(color: Colors.white.withOpacity(.70)),
    ));

    return list;
  }

  Widget _tile({required String title, required String subtitle, required bool proOnly, required VoidCallback onTap}) {
    final locked = proOnly && !_pro;

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        margin: const EdgeInsets.only(bottom: 10),
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          color: AppTheme.card,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppTheme.border.withOpacity(.35)),
        ),
        child: Row(
          children: [
            Icon(locked ? Icons.lock : Icons.flash_on, color: locked ? Colors.white70 : AppTheme.gold),
            const SizedBox(width: 10),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(title, style: const TextStyle(fontWeight: FontWeight.w900)),
                  Text(subtitle, style: TextStyle(color: Colors.white.withOpacity(.65))),
                ],
              ),
            ),
            Icon(Icons.chevron_right, color: Colors.white.withOpacity(.55)),
          ],
        ),
      ),
    );
  }
}

class _EquipItem {
  final String title;
  final String subtitle;
  final bool proOnly;
  final VoidCallback onTap;

  const _EquipItem._(this.title, this.subtitle, this.proOnly, this.onTap);

  factory _EquipItem.free(String title, String subtitle, VoidCallback onTap) =>
      _EquipItem._(title, subtitle, false, onTap);

  factory _EquipItem.pro(String title, String subtitle, VoidCallback onTap) =>
      _EquipItem._(title, subtitle, true, onTap);
}
